<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="python">
  <head>
    <meta charset="utf-8" />
    <title>eonr.eonr &#8212; eonr 0.2.0 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"extensions": ["tex2jax.js"], "jax": ["input/TeX", "output/HTML-CSS"], "tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          EONR</a>
        <span class="navbar-text navbar-version pull-left"><b>0.2.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://github.com/tnigon/eonr">Github</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Contents <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">1. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">2. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced_tutorial.html">3. Advanced Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../background.html">4. Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../my_eonr.html">5. API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">6. License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">7. Change Log</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
<form action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="col-md-9 content">
      
  <h1>Source code for eonr.eonr</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&#39;&#39;&#39;**Calculates the economic optimum nitrogen rate and plots the results**</span>

<span class="sd">``EONR`` is a Python package for computing the economic optimum nitrogen</span>
<span class="sd">fertilizer rate using data from agronomic field trials under economic</span>
<span class="sd">conditions defined by the user (i.e., grain price and fertilizer cost).</span>
<span class="sd">It can be used for any crop (e.g., corn, wheat, potatoes, etc.), but the</span>
<span class="sd">current version only supports use of the quadratic-plateau piecewise</span>
<span class="sd">model.</span>

<span class="sd">**Therefore, use caution in making sure that a quadratic-plateau model is</span>
<span class="sd">appropriate for your application.** Future versions should add support for</span>
<span class="sd">other models (quadratic, spherical, etc.) that may improve the fit of</span>
<span class="sd">experimental yield response to nitrogen for other crops.</span>

<span class="sd">*Optional arguments when creating an instance of* ``EONR``:</span>

<span class="sd">Parameters:</span>
<span class="sd">    cost_n_fert (float, optional): Cost of N fertilizer (default: 0.50)</span>
<span class="sd">    cost_n_social (float, optional): Social cost of N fertilier (default: 0.00)</span>
<span class="sd">    costs_fixed (float, optional): Fixed costs on a per area basis (default:</span>
<span class="sd">        0.00)</span>
<span class="sd">    price_grain (float, optional): Price of grain (default: 3.00)</span>
<span class="sd">    col_n_app (str, optional): Column name pointing to the rate of applied N</span>
<span class="sd">        fertilizer data (default: &#39;rate_n_applied_lbac&#39;)</span>
<span class="sd">    col_yld (str, optional): Column name pointing to the grain yield data. This</span>
<span class="sd">        column is multiplied by price_grain to create the &#39;grtn&#39; column in</span>
<span class="sd">        ``EONR.df_data`` (default: &#39;yld_grain_dry_buac&#39;)</span>
<span class="sd">    col_crop_nup (str, optional): Column name pointing to crop N uptake data</span>
<span class="sd">        (default: &#39;nup_total_lbac&#39;)</span>
<span class="sd">    col_n_avail (str, optional): Column name pointing to available soil N plus</span>
<span class="sd">        fertilizer  (default: &#39;soil_plus_fert_n_lbac&#39;)</span>
<span class="sd">    col_year (str, optional): Column name pointing to year (default: &#39;year&#39;)</span>
<span class="sd">    col_location (str, optional): Column name pointing to location (default:</span>
<span class="sd">        &#39;location&#39;)</span>
<span class="sd">    col_time_n (str, optional): Column name pointing to nitrogen application</span>
<span class="sd">        timing (default: &#39;time_n&#39;)</span>
<span class="sd">    unit_currency (str, optional): String describing the curency unit (default:</span>
<span class="sd">        &#39;$&#39;)</span>
<span class="sd">    unit_fert (str, optional): String describing the &quot;fertilizer&quot; unit</span>
<span class="sd">        (default: &#39;lbs&#39;)</span>
<span class="sd">    unit_grain (str, optional): String describing the &quot;grain&quot; unit (default:</span>
<span class="sd">        &#39;bu&#39;)</span>
<span class="sd">    unit_area (str, optional): String descibing the &quot;area&quot; unit (default: &#39;ac&#39;)</span>
<span class="sd">    model (str, optional): Statistical model used to fit N rate response.</span>
<span class="sd">        *&#39;quad_plateau&#39;* = quadratic plateau; *&#39;quadratic&#39;* = quadratic;</span>
<span class="sd">        ``None`` = fits each of the preceding models, and uses the one with the</span>
<span class="sd">        highest R2 (default: &#39;quad_plateau&#39;).</span>
<span class="sd">    ci_level (float, optional): Confidence interval level to save in</span>
<span class="sd">        ``EONR.df_results`` and to display in the EONR plot; note that</span>
<span class="sd">        confidence intervals are calculated at many alpha levels, and we should</span>
<span class="sd">        choose from that list - should be one of [0.1, 0.2, 0.3, 0.4, 0.5, 0.6,</span>
<span class="sd">        0.667, 0.7, 0.8, 0.9, 0.95, or 0.99] (default: 0.90)</span>
<span class="sd">    base_dir (str, optional): Base file directory when saving results (default:</span>
<span class="sd">        None)</span>
<span class="sd">    base_zero (``bool``, optional): Determines if gross return to N is</span>
<span class="sd">        expressed as an absolute value or relative to the yield/return at the</span>
<span class="sd">        zero rate. If base_zero is True, observed data for the zero nitrogen</span>
<span class="sd">        rate will be standardized by subtracting the y-intercept</span>
<span class="sd">        (:math:`\\beta_0`) from the &#39;grtn&#39; column of ``EONR.df_data``.</span>
<span class="sd">        (default: True)</span>
<span class="sd">    print_out (``bool``, optional): Determines if &quot;non-essential&quot; results are</span>
<span class="sd">        printed in the Python console (default: False)</span>

<span class="sd">Requirements:</span>
<span class="sd">    The minimum data requirement to utilize this package is observed (or</span>
<span class="sd">    simulated) experimental data of agronomic yield response to nitrogen</span>
<span class="sd">    fertilizer. In other words, your experiment should have multiple nitrogen</span>
<span class="sd">    rate treatments, and you should have measured the yield for each</span>
<span class="sd">    experimental plot at the end of the season. Suitable experimental design</span>
<span class="sd">    for your particular experiment is always suggested (e.g., it should</span>
<span class="sd">    probably be replicated).</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">scikits</span> <span class="k">import</span> <span class="n">bootstrap</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">minimize_scalar</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">OptimizeWarning</span>
<span class="kn">import</span> <span class="nn">uncertainties</span> <span class="k">as</span> <span class="nn">unc</span>
<span class="kn">from</span> <span class="nn">uncertainties</span> <span class="k">import</span> <span class="n">unumpy</span> <span class="k">as</span> <span class="n">unp</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">eonr</span> <span class="k">import</span> <span class="n">Models</span>
<span class="kn">from</span> <span class="nn">eonr</span> <span class="k">import</span> <span class="n">Plotting_tools</span>


<div class="viewcode-block" id="EONR"><a class="viewcode-back" href="../../my_eonr.html#eonr.eonr.EONR">[docs]</a><span class="k">class</span> <span class="nc">EONR</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">cost_n_fert</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                 <span class="n">cost_n_social</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">costs_fixed</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">price_grain</span><span class="o">=</span><span class="mf">3.00</span><span class="p">,</span>
                 <span class="n">col_n_app</span><span class="o">=</span><span class="s1">&#39;rate_n_applied_lbac&#39;</span><span class="p">,</span>
                 <span class="n">col_yld</span><span class="o">=</span><span class="s1">&#39;yld_grain_dry_buac&#39;</span><span class="p">,</span>
                 <span class="n">col_crop_nup</span><span class="o">=</span><span class="s1">&#39;nup_total_lbac&#39;</span><span class="p">,</span>
                 <span class="n">col_n_avail</span><span class="o">=</span><span class="s1">&#39;soil_plus_fert_n_lbac&#39;</span><span class="p">,</span>
                 <span class="n">col_year</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">col_location</span><span class="o">=</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="n">col_time_n</span><span class="o">=</span><span class="s1">&#39;time_n&#39;</span><span class="p">,</span>
                 <span class="n">unit_currency</span><span class="o">=</span><span class="s1">&#39;$&#39;</span><span class="p">,</span>
                 <span class="n">unit_fert</span><span class="o">=</span><span class="s1">&#39;lbs&#39;</span><span class="p">,</span> <span class="n">unit_grain</span><span class="o">=</span><span class="s1">&#39;bu&#39;</span><span class="p">,</span> <span class="n">unit_area</span><span class="o">=</span><span class="s1">&#39;ac&#39;</span><span class="p">,</span>
                 <span class="n">model</span><span class="o">=</span><span class="s1">&#39;quad_plateau&#39;</span><span class="p">,</span> <span class="n">ci_level</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">base_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">print_out</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_fert</span> <span class="o">=</span> <span class="n">cost_n_fert</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">=</span> <span class="n">cost_n_social</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">costs_fixed</span> <span class="o">=</span> <span class="n">costs_fixed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_grain</span> <span class="o">=</span> <span class="n">price_grain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_ratio</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_n_fert</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span><span class="p">)</span> <span class="o">/</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">price_grain</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span> <span class="o">=</span> <span class="n">col_n_app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_yld</span> <span class="o">=</span> <span class="n">col_yld</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_crop_nup</span> <span class="o">=</span> <span class="n">col_crop_nup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_n_avail</span> <span class="o">=</span> <span class="n">col_n_avail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_year</span> <span class="o">=</span> <span class="n">col_year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_location</span> <span class="o">=</span> <span class="n">col_location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_time_n</span> <span class="o">=</span> <span class="n">col_time_n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_currency</span> <span class="o">=</span> <span class="n">unit_currency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_fert</span> <span class="o">=</span> <span class="n">unit_fert</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_grain</span> <span class="o">=</span> <span class="n">unit_grain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_area</span> <span class="o">=</span> <span class="n">unit_area</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_rtn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> per </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_currency</span><span class="p">,</span> <span class="n">unit_area</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_nrate</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> per </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_fert</span><span class="p">,</span> <span class="n">unit_area</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_level</span> <span class="o">=</span> <span class="n">ci_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_zero</span> <span class="o">=</span> <span class="n">base_zero</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_out</span> <span class="o">=</span> <span class="n">print_out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_n</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onr_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onr_acr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># price_ratio to use when finding theta2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn_primary</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># only used if self.base_zero is True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_temp</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mrtn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">costs_at_onr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_ci_pdf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_delta_tstat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_der</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_linspace</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fig_delta_tstat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig_derivative</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig_eonr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig_tau</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.667</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span>
                        <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">xi</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;price_grain&#39;</span><span class="p">,</span> <span class="s1">&#39;cost_n_fert&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;cost_n_social&#39;</span><span class="p">,</span> <span class="s1">&#39;costs_fixed&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;price_ratio&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;unit_price_grain&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;unit_cost_n&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;time_n&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;base_zero&#39;</span><span class="p">,</span> <span class="s1">&#39;eonr&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;eonr_bias&#39;</span><span class="p">,</span> <span class="s1">&#39;R*&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;costs_at_onr&#39;</span><span class="p">,</span> <span class="s1">&#39;ci_level&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;ci_wald_l&#39;</span><span class="p">,</span> <span class="s1">&#39;ci_wald_u&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;ci_pl_l&#39;</span><span class="p">,</span> <span class="s1">&#39;ci_pl_u&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;ci_boot_l&#39;</span><span class="p">,</span> <span class="s1">&#39;ci_boot_u&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;mrtn&#39;</span><span class="p">,</span> <span class="s1">&#39;grtn_r2_adj&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;grtn_rmse&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;grtn_max_y&#39;</span><span class="p">,</span> <span class="s1">&#39;grtn_crit_x&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;grtn_y_int&#39;</span><span class="p">,</span> <span class="s1">&#39;scn_lin_r2&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;scn_lin_rmse&#39;</span><span class="p">,</span> <span class="s1">&#39;scn_exp_r2&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;scn_exp_rmse&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_ci</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_grain</span> <span class="o">==</span> <span class="s1">&#39;kg&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_area</span> <span class="o">==</span> <span class="s1">&#39;ha&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_grain</span> <span class="o">==</span> <span class="s1">&#39;lbs&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_area</span> <span class="o">==</span> <span class="s1">&#39;ac&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># unknown</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;eonr_temp_output&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;trad_000&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onr_name</span> <span class="o">=</span> <span class="s1">&#39;Socially&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onr_acr</span> <span class="o">=</span> <span class="s1">&#39;SONR&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_fert</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onr_name</span> <span class="o">=</span> <span class="s1">&#39;Economic&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onr_acr</span> <span class="o">=</span> <span class="s1">&#39;EONR&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onr_name</span> <span class="o">=</span> <span class="s1">&#39;Agronomic&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onr_acr</span> <span class="o">=</span> <span class="s1">&#39;AONR&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">Models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span> <span class="o">=</span> <span class="n">Plotting_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_eonr</span><span class="o">.</span><span class="vm">__func__</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">plot_eonr</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_tau</span><span class="o">.</span><span class="vm">__func__</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">plot_tau</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_save</span><span class="o">.</span><span class="vm">__func__</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">plot_save</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="c1">#  Following are the miscellaneous functions</span>
    <span class="k">def</span> <span class="nf">_reset_temp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Resets temporary variables to be sure nothing carries through from a</span>
<span class="sd">        previous run</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_temp</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;grtn_y_int&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="s1">&#39;scn_lin_r2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="s1">&#39;scn_lin_rmse&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="s1">&#39;scn_exp_r2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="s1">&#39;scn_exp_rmse&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_find_trial_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Uses EONR.col_XXXXXXX to get year, location, and time_n from</span>
<span class="sd">        EONR.df_data</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">col_location</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Was not able to infer &quot;</span><span class="si">{0}</span><span class="s1">&quot; from EONR.df_data; &#39;</span>
                      <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot; is currently set to </span><span class="si">{1}</span><span class="s1">. If this is not &#39;</span>
                      <span class="s1">&#39;correct, adjust prior to plotting using &#39;</span>
                      <span class="s1">&#39;EONR.set_column_names(col_location=&quot;your_loc_col_name&quot;)&#39;</span>
                      <span class="s1">&#39; or EONR.set_trial_details(</span><span class="si">{0}</span><span class="s1">=&quot;your_location&quot;)&#39;</span>
                      <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> is not currently set. You may want to set prior to &#39;</span>
                      <span class="s1">&#39;plotting using &#39;</span>
                      <span class="s1">&#39;EONR.set_column_names(col_location=&quot;your_loc_col_name&quot;)&#39;</span>
                      <span class="s1">&#39; or EONR.set_trial_details(</span><span class="si">{0}</span><span class="s1">=&quot;your_location&quot;)&#39;</span>
                      <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">col_year</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Was not able to infer &quot;</span><span class="si">{0}</span><span class="s1">&quot; from EONR.df_data; &#39;</span>
                      <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot; is currently set to </span><span class="si">{1}</span><span class="s1">. If this is not &#39;</span>
                      <span class="s1">&#39;correct, adjust prior to plotting using &#39;</span>
                      <span class="s1">&#39;EONR.set_column_names(col_year=&quot;your_year_col_name&quot;)&#39;</span>
                      <span class="s1">&#39; or EONR.set_trial_details(</span><span class="si">{0}</span><span class="s1">=&quot;your_year&quot;)&#39;</span>
                      <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> is not currently set. You may want to set prior to &#39;</span>
                      <span class="s1">&#39;plotting using &#39;</span>
                      <span class="s1">&#39;EONR.set_column_names(col_year=&quot;your_year_col_name&quot;)&#39;</span>
                      <span class="s1">&#39; or EONR.set_trial_details(</span><span class="si">{0}</span><span class="s1">=&quot;your_year&quot;)&#39;</span>
                      <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_n</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">col_time_n</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Was not able to infer &quot;</span><span class="si">{0}</span><span class="s1">&quot; from EONR.df_data; &#39;</span>
                      <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot; is currently set to </span><span class="si">{1}</span><span class="s1">. If this is not &#39;</span>
                      <span class="s1">&#39;correct, adjust prior to plotting using &#39;</span>
                      <span class="s1">&#39;EONR.set_column_names(col_time_n=&quot;your_time_n_col_name&quot;)&#39;</span>
                      <span class="s1">&#39; or EONR.set_trial_details(</span><span class="si">{0}</span><span class="s1">=&quot;your_time_n&quot;)&#39;</span>
                      <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;time_n&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_n</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> is not currently set. You may want to set prior to &#39;</span>
                      <span class="s1">&#39;plotting using &#39;</span>
                      <span class="s1">&#39;EONR.set_column_names(col_time_n=&quot;your_time_n_col_name&quot;)&#39;</span>
                      <span class="s1">&#39; or EONR.set_trial_details(</span><span class="si">{0}</span><span class="s1">=&quot;your_time_n&quot;)&#39;</span>
                      <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;time_n&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_set_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Basic setup for dataframe</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_find_trial_details</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Computing </span><span class="si">{0}</span><span class="s1"> for </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3}</span><span class="s1">&#39;</span>
              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Cost of N fertilizer: </span><span class="si">{4}{5:.2f}</span><span class="s1"> per </span><span class="si">{6}</span><span class="s1">&#39;</span>
              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Price grain: </span><span class="si">{4}{7:.2f}</span><span class="s1"> per </span><span class="si">{8}</span><span class="s1">&#39;</span>
              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Fixed costs: </span><span class="si">{4}{9:.2f}</span><span class="s1"> per </span><span class="si">{10}</span><span class="s1">&#39;</span>
              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onr_acr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_n</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">unit_currency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_fert</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_fert</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">price_grain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_grain</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">costs_fixed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_area</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Social cost of N: </span><span class="si">{0}{1:.2f}</span><span class="s1"> per </span><span class="si">{2}</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_currency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">unit_fert</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_replace_missing_vals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">missing_val</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds missing data in pandas dataframe and replaces with np.nan</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">missing_val</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1">#  Following are curve_fit helpers and statistical calculations</span>
    <span class="k">def</span> <span class="nf">_best_fit_lin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes slope, intercept, r2, and RMSE of linear best fit line between</span>
<span class="sd">        &lt;col_x&gt; and &lt;col_y&gt; of eonr.df_data</span>

<span class="sd">        Note that the &#39;social_cost_n&#39; (&lt;col_y&gt;) already considers the economic</span>
<span class="sd">        scenario, so it doesn&#39;t have to be added again later</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_x</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_y</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mx</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">lin_r2</span> <span class="o">=</span> <span class="n">r_value</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">mx</span><span class="o">*</span><span class="n">X</span><span class="p">)</span>
        <span class="n">ss_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">lin_rmse</span> <span class="o">=</span> <span class="p">(</span><span class="n">ss_res</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;lin_mx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;lin_b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;lin_r2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lin_r2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;lin_rmse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lin_rmse</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_out</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">y = </span><span class="si">{0:.5}</span><span class="s1"> + </span><span class="si">{1:.5}</span><span class="s1">x&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">mx</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lin_r2 = </span><span class="si">{0:.3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lin_r2</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RMSE = </span><span class="si">{0:.1f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lin_rmse</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_best_fit_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">,</span> <span class="n">guess_a</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">guess_b</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
                      <span class="n">guess_c</span><span class="o">=-</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes a, b, and c of best fit exponential function between &lt;col_x&gt;</span>
<span class="sd">        and &lt;col_y&gt;</span>

<span class="sd">        Note that the &#39;social_cost_n&#39; (&lt;col_y&gt;) already considers the economic</span>
<span class="sd">        scenario, so it doesn&#39;t have to be added again later</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_x</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_y</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">popt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;func = </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">col_x = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">col_y = </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;_best_fit_exp() -&gt; _f_exp&#39;</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_opt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                                             <span class="n">p0</span><span class="o">=</span><span class="p">(</span><span class="n">guess_a</span><span class="p">,</span> <span class="n">guess_b</span><span class="p">,</span> <span class="n">guess_c</span><span class="p">),</span>
                                             <span class="n">maxfev</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">Trying a new guess before giving up..&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">popt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_opt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                                                 <span class="n">p0</span><span class="o">=</span><span class="p">(</span><span class="n">guess_a</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span>
                                                     <span class="n">guess_b</span><span class="o">**</span><span class="mi">10</span><span class="p">,</span>
                                                     <span class="n">guess_c</span><span class="o">*</span><span class="mi">10</span><span class="p">),</span>
                                                 <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">Try adjusting the initial guess parameters..&#39;</span>
                      <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">popt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">popt</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_out</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t fit data to an exponential function..</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_gamma0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_gamma1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_gamma2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_r2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_rmse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exp_r2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">exp_rmse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                                                      <span class="n">popt</span><span class="p">)</span>
            <span class="n">gamma0</span><span class="p">,</span> <span class="n">gamma1</span><span class="p">,</span> <span class="n">gamma2</span> <span class="o">=</span> <span class="n">popt</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_out</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;y = </span><span class="si">{0:.5}</span><span class="s1"> * exp(</span><span class="si">{1:.5}</span><span class="s1">x) + </span><span class="si">{2:.5}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gamma0</span><span class="p">,</span> <span class="n">gamma1</span><span class="p">,</span> <span class="n">gamma2</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;exp_r2 = </span><span class="si">{0:.3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp_r2</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RMSE = </span><span class="si">{0:.1f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp_rmse</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_gamma0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_gamma1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_gamma2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_r2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_r2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_rmse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_rmse</span>

    <span class="k">def</span> <span class="nf">_calc_aic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;gamma&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the Akaike information criterion (AIC) using either a gamma</span>
<span class="sd">        (&lt;dist&gt;=&#39;gamma&#39;) or normal (&lt;dist&gt;=&#39;normal&#39;) distribution</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span>
            <span class="n">fitted_params</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">log_lik</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">fitted_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">loc</span><span class="o">=</span><span class="n">fitted_params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                <span class="n">scale</span><span class="o">=</span><span class="n">fitted_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
            <span class="n">fitted_params</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">log_lik</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">fitted_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                               <span class="n">loc</span><span class="o">=</span><span class="n">fitted_params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                               <span class="n">scale</span><span class="o">=</span><span class="n">fitted_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fitted_params</span><span class="p">)</span>
        <span class="n">aic</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">log_lik</span>
        <span class="k">return</span> <span class="n">aic</span>

    <span class="k">def</span> <span class="nf">_curve_fit_bs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">800</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Helper function to be suppress the OptimizeWarning. The bootstrap</span>
<span class="sd">        computation doesn&#39;t use the covariance matrix anyways (which is the</span>
<span class="sd">        main cause of the OptimizeWarning being thrown).</span>
<span class="sd">        (added so I can figure out what part of the code is causing it)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">OptimizeWarning</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span>
                                       <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span>
            <span class="k">except</span> <span class="n">OptimizeWarning</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">OptimizeWarning</span><span class="p">)</span>  <span class="c1"># hides warning</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span>

    <span class="k">def</span> <span class="nf">_curve_fit_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Helper function to suppress the OptimizeWarning. The bootstrap</span>
<span class="sd">        computation doesn&#39;t use the covariance matrix anyways (which is the</span>
<span class="sd">        main cause of the OptimizeWarning being thrown).</span>
<span class="sd">        (added so I can figure out what part of the code is causing it)</span>
<span class="sd">        &lt;info&gt; is a variable holding the column headings of the x and y data</span>
<span class="sd">        and is printed out to provide information to know which curve_fit</span>
<span class="sd">        functions are throwing the OptimizeWarning</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">OptimizeWarning</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span>
                                           <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">OptimizeWarning</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_out</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Information for which the OptimizeWarning was &#39;</span>
                              <span class="s1">&#39;thrown:</span><span class="se">\n</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">OptimizeWarning</span><span class="p">)</span>  <span class="c1"># hides warn</span>
                <span class="c1"># essentially ignore warning and run anyway</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span>
                                       <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span>

    <span class="k">def</span> <span class="nf">_curve_fit_runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Helper function to run curve_fit() and watch for a RuntimeError. If we</span>
<span class="sd">        get a RuntimeError, then increase maxfev by 10x and try again.</span>
<span class="sd">        Sometimes this solves the problem of not being able to fit the</span>
<span class="sd">        function. If so, returns popt and pcov; if not, prints the error and</span>
<span class="sd">        returns None.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">popt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_opt</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span>
                                             <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">maxfev</span> <span class="o">*=</span> <span class="mi">10</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Increasing the maximum number of calls to the function to &#39;</span>
                  <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> before giving up.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxfev</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">popt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_opt</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span>
                                                 <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Was not able to fit data to the function.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">popt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_compute_R</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given the true EONR with social cost considered, goal is to find the</span>
<span class="sd">        price ratio that will provide a sum of squares calculation for the true</span>
<span class="sd">        EONR</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">col_x</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">col_y</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">b1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">)</span>  <span class="c1"># as a starting point</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">update_eonr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quadratic&#39;</span><span class="p">:</span>
                <span class="n">f_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">quadratic</span>
                <span class="n">f_model_theta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">q_theta2</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quad_plateau&#39;</span><span class="p">:</span>
                <span class="n">f_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">quad_plateau</span>
                <span class="n">f_model_theta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">qp_theta2</span>
            <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;func = </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">col_x = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">col_y = </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">))</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_runtime</span><span class="p">(</span><span class="n">f_model_theta2</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span>
                                                 <span class="n">maxfev</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
            <span class="n">dif</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">dif</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using the optimize_R() algorithm&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">epsilon</span> <span class="o">*=</span> <span class="mi">10</span>
                <span class="k">elif</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not converge R to fit the &#39;</span>
                          <span class="s1">&#39;EONR after </span><span class="si">{0}</span><span class="s1"> attemps. Fitted &#39;</span>
                          <span class="s1">&#39;model is within </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> of the &#39;</span>
                          <span class="s1">&#39;computed EONR.&#39;</span>
                          <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">dif</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">unit_nrate</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">+=</span> <span class="n">step_size</span>  <span class="c1"># increase R</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># assumes R should aloways be positive</span>
                    <span class="c1"># go back one and increase at finer step</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">-=</span> <span class="n">step_size</span>
                    <span class="n">step_size</span> <span class="o">*=</span> <span class="mf">0.1</span>  <span class="c1"># change step_size</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">+=</span> <span class="n">step_size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">update_eonr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_runtime</span><span class="p">(</span><span class="n">f_model_theta2</span><span class="p">,</span>
                                                     <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
                <span class="n">dif</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">f_model_theta2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
            <span class="n">ss_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">popt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">popt</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pcov</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)):</span>
                <span class="n">b0</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">ufloat</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">theta2</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">ufloat</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">b2</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">ufloat</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b0</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">correlated_values</span><span class="p">(</span><span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;func = </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">col_x = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">col_y = </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span>
                              <span class="n">col_y</span> <span class="o">+</span> <span class="s1">&#39; (residuals)&#39;</span><span class="p">))</span>
<span class="c1">#            func = self.models.quad_plateau</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_opt</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">b1</span><span class="p">:</span> <span class="n">f_model</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">b0</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">n</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
            <span class="n">popt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">popt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
            <span class="n">popt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">popt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">b0</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">popt</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">minimize_scalar</span><span class="p">(</span><span class="o">-</span><span class="n">f</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;theta2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;theta2_social&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;popt_social&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                              <span class="n">theta2</span><span class="p">,</span>
                                              <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;ss_res_social&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss_res</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;eonr_bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_ratio</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_grain</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Please compute EONR&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">update_eonr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_rsq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">popt</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the r-square (and ajusted r-square) of &lt;y&gt; for function</span>
<span class="sd">        &lt;func&gt; with &lt;popt&gt; parameters</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
        <span class="n">ss_res_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="p">(</span><span class="n">ss_res_mean</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">y_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">ss_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ss_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">y_mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">ss_res</span><span class="o">/</span><span class="n">ss_tot</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">popt</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">r2_adj</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">r2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r2_adj</span><span class="p">,</span> <span class="n">ss_res</span><span class="p">,</span> <span class="n">ss_tot</span><span class="p">,</span> <span class="n">rmse</span>

    <span class="c1">#  Following are higher level functions</span>
    <span class="k">def</span> <span class="nf">_build_mrtn_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Builds the Net Return to N (MRTN) line for plotting</span>

<span class="sd">        Parameters:</span>
<span class="sd">        n_steps (``int``): Number of nitrogen rates to be calculated to</span>
<span class="sd">            represent the GRTN curve (default: None - set dynamically as two</span>
<span class="sd">            steps per unit N).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">eonr_social_n</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">x1</span><span class="p">,</span> <span class="n">y_fert_n</span><span class="p">,</span> <span class="n">x1a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_ncost_curve</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span>
        <span class="n">eonr_fert_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_fert</span>
        <span class="n">y_grtn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_grtn_curve</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x1a</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">y_social_n</span><span class="p">,</span> <span class="n">eonr_social_n</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_social_curve</span><span class="p">(</span>
                    <span class="n">x1</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="n">y_grtn</span> <span class="o">-</span> <span class="p">(</span><span class="n">y_fert_n</span> <span class="o">+</span> <span class="n">y_social_n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linspace_cost_n_social</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y_social_n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="n">y_grtn</span> <span class="o">-</span> <span class="n">y_fert_n</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_grtn</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_steps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_grtn</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_steps</span><span class="p">:</span>
                <span class="n">y_grtn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_grtn</span><span class="p">,</span> <span class="n">y_grtn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_grtn</span> <span class="o">=</span> <span class="n">y_grtn</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rtn_der</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">rtn</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">rtn_der2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">rtn_der</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">df_linspace</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x1</span><span class="p">,</span>
                                    <span class="s1">&#39;cost_n_fert&#39;</span><span class="p">:</span> <span class="n">y_fert_n</span><span class="p">,</span>
                                    <span class="s1">&#39;quad_plat&#39;</span><span class="p">:</span> <span class="n">y_grtn</span><span class="p">,</span>
                                    <span class="s1">&#39;rtn&#39;</span><span class="p">:</span> <span class="n">rtn</span><span class="p">,</span>
                                    <span class="s1">&#39;rtn_der&#39;</span><span class="p">:</span> <span class="n">rtn_der</span><span class="p">,</span>
                                    <span class="s1">&#39;rtn_der2&#39;</span><span class="p">:</span> <span class="n">rtn_der2</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">df_linspace</span><span class="p">[</span><span class="s1">&#39;cost_n_social&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_social_n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_linspace</span> <span class="o">=</span> <span class="n">df_linspace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">costs_at_onr</span> <span class="o">=</span> <span class="n">eonr_fert_n</span> <span class="o">+</span> <span class="n">eonr_social_n</span>

    <span class="k">def</span> <span class="nf">_ci_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the probability density function across all calculatd</span>
<span class="sd">        confidence interval levels</span>

<span class="sd">        Parameters:</span>
<span class="sd">            run_n (``int``): (default: ``None``)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">run_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;run_n&#39;</span><span class="p">]</span> <span class="o">==</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;run_n&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;run_n&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">run_n</span><span class="p">]</span>
        <span class="n">val_min</span> <span class="o">=</span> <span class="n">df_ci</span><span class="p">[</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.99</span><span class="p">][</span><span class="s1">&#39;pl_l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">val_max</span> <span class="o">=</span> <span class="n">df_ci</span><span class="p">[</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.99</span><span class="p">][</span><span class="s1">&#39;pl_u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">val_min</span><span class="p">,</span> <span class="n">val_max</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span>

        <span class="n">level_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">level_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pl_l</span> <span class="o">=</span> <span class="n">df_ci</span><span class="p">[</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">level</span><span class="p">][</span><span class="s1">&#39;pl_l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pl_u</span> <span class="o">=</span> <span class="n">df_ci</span><span class="p">[</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">level</span><span class="p">][</span><span class="s1">&#39;pl_u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">weight_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">level</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">weight_out</span> <span class="o">=</span> <span class="mi">100</span><span class="o">-</span><span class="n">weight_in</span>  <span class="c1"># 99 because 0 CI is excluded</span>
<span class="c1">#                idx_l = (np.abs(x_all - pl_l)).argmin()  # find nearest index</span>
<span class="c1">#                idx_u = (np.abs(x_all - pl_u)).argmin()</span>
                <span class="n">dif_l</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_all</span> <span class="o">-</span> <span class="n">pl_l</span><span class="p">)</span>  <span class="c1"># find index above</span>
                <span class="n">dif_u</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl_u</span> <span class="o">-</span> <span class="n">x_all</span><span class="p">)</span>  <span class="c1"># find index below</span>
                <span class="n">idx_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dif_l</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">dif_l</span><span class="p">,</span> <span class="n">dif_l</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
                <span class="n">idx_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dif_u</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">dif_u</span><span class="p">,</span> <span class="n">dif_u</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

                <span class="n">unit_weight_in</span> <span class="o">=</span> <span class="n">weight_in</span> <span class="o">/</span> <span class="p">(</span><span class="n">idx_u</span> <span class="o">-</span> <span class="n">idx_l</span><span class="p">)</span>
                <span class="n">unit_weight_out</span> <span class="o">=</span> <span class="n">weight_out</span> <span class="o">/</span> <span class="p">((</span><span class="n">idx_l</span> <span class="o">-</span> <span class="n">x_all</span><span class="o">.</span><span class="n">argmin</span><span class="p">())</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_steps</span> <span class="o">-</span> <span class="n">idx_u</span><span class="p">))</span>
                <span class="n">weights</span><span class="p">[:</span><span class="n">idx_l</span><span class="p">]</span> <span class="o">+=</span> <span class="n">unit_weight_out</span>  <span class="c1"># add to weights</span>
                <span class="n">weights</span><span class="p">[</span><span class="n">idx_u</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">unit_weight_out</span>
                <span class="n">weights</span><span class="p">[</span><span class="n">idx_l</span><span class="p">:</span><span class="n">idx_u</span><span class="p">]</span> <span class="o">+=</span> <span class="n">unit_weight_in</span>
        <span class="n">df_ci_pdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;rate_n&#39;</span><span class="p">:</span> <span class="n">x_all</span><span class="p">,</span>
                                  <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">weights</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_ci_pdf</span> <span class="o">=</span> <span class="n">df_ci_pdf</span>

    <span class="k">def</span> <span class="nf">_rtn_derivative</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calcuales the first derivative of the return to N curve</span>

<span class="sd">        Parameters:</span>
<span class="sd">            run_n (``int``): (default: ``None``)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df_ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;run_n&#39;</span><span class="p">]</span> <span class="o">==</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;run_n&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">pl_l</span> <span class="o">=</span> <span class="n">df_ci</span><span class="p">[</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_level</span><span class="p">][</span><span class="s1">&#39;pl_l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pl_u</span> <span class="o">=</span> <span class="n">df_ci</span><span class="p">[</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_level</span><span class="p">][</span><span class="s1">&#39;pl_u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_linspace</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;rtn_der&#39;</span><span class="p">,</span> <span class="s1">&#39;rtn_der2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_trim</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">pl_l</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">pl_u</span><span class="p">)]</span>
        <span class="n">df_trim</span> <span class="o">=</span> <span class="n">df_trim</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">df_trim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">der_max</span> <span class="o">=</span> <span class="n">df_trim</span><span class="p">[</span><span class="s1">&#39;rtn_der&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">df_trim</span> <span class="o">=</span> <span class="n">df_trim</span><span class="p">[(</span><span class="n">df_trim</span><span class="p">[</span><span class="s1">&#39;rtn_der&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">der_max</span><span class="p">)</span> <span class="o">&amp;</span>
                          <span class="p">(</span><span class="n">df_trim</span><span class="p">[</span><span class="s1">&#39;rtn_der2&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">)]</span>
        <span class="n">df_der_left</span> <span class="o">=</span> <span class="n">df_trim</span><span class="p">[</span><span class="n">df_trim</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">]</span>
        <span class="n">df_der_right</span> <span class="o">=</span> <span class="n">df_trim</span><span class="p">[</span><span class="n">df_trim</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">]</span>
        <span class="n">slope_coef</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_trim</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> <span class="o">/</span>
                      <span class="p">(</span><span class="n">df_trim</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">df_trim</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">slope_l</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">df_der_left</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
                                                   <span class="n">df_der_left</span><span class="p">[</span><span class="s1">&#39;rtn_der&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;der_slope_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slope_l</span> <span class="o">*</span> <span class="n">slope_coef</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;der_slope_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">slope_u</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">df_der_right</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
                                                   <span class="n">df_der_right</span><span class="p">[</span><span class="s1">&#39;rtn_der&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;der_slope_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slope_u</span> <span class="o">*</span> <span class="n">slope_coef</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;der_slope_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">def</span> <span class="nf">_build_social_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Generates an array for the Social cost of N curve</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">fixed</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">y_social_n</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span>
            <span class="n">eonr_social_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;lin_r2&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_r2&#39;</span><span class="p">]:</span>
                <span class="n">y_social_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;lin_b&#39;</span><span class="p">]</span> <span class="o">+</span>\
                        <span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;lin_mx&#39;</span><span class="p">])</span>
                <span class="n">eonr_social_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;lin_b&#39;</span><span class="p">]</span> <span class="o">+</span>\
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eonr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;lin_mx&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x1_exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_gamma0&#39;</span><span class="p">]</span> <span class="o">*</span>\
                        <span class="n">unp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_gamma1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x1</span><span class="p">)</span> <span class="o">+</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_gamma2&#39;</span><span class="p">]</span>
                <span class="n">y_social_n</span> <span class="o">=</span> <span class="n">unp</span><span class="o">.</span><span class="n">nominal_values</span><span class="p">(</span><span class="n">x1_exp</span><span class="p">)</span>
                <span class="n">eonr_social_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_gamma0&#39;</span><span class="p">]</span> <span class="o">*</span>\
                        <span class="n">unp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_gamma1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">)</span> <span class="o">+</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_gamma2&#39;</span><span class="p">]</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">unp</span><span class="o">.</span><span class="n">std_devs</span><span class="p">(</span><span class="n">x1_exp</span><span class="p">)</span>
                <span class="n">ci_l</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_social_n</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span>
                <span class="n">ci_u</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_social_n</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y_social_n</span><span class="p">,</span> <span class="n">eonr_social_n</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span>

    <span class="k">def</span> <span class="nf">_calc_grtn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes Gross Return to N and saves in df_data under column heading of</span>
<span class="sd">        &#39;grtn&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;grtn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">col_yld</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">price_grain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_model</span><span class="p">(</span><span class="n">col_x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span><span class="p">,</span> <span class="n">col_y</span><span class="o">=</span><span class="s1">&#39;grtn&#39;</span><span class="p">)</span>
<span class="c1">#        if model == &#39;quad_plateau&#39;:</span>
<span class="c1">#            # Calculate the coefficients describing the quadratic plateau model</span>
<span class="c1">#            self._quad_plateau(col_x=self.col_n_app, col_y=&#39;grtn&#39;)</span>
<span class="c1">#        elif model == &#39;quadratic&#39;:</span>
<span class="c1">#            self.</span>
<span class="c1">#        elif model == &#39;lin_plateau&#39;:</span>
<span class="c1">#            self._r_lin_plateau(col_x=self.col_n_app, col_y=&#39;grtn&#39;)</span>
<span class="c1">#            self._r_confint(level=0.8)</span>
<span class="c1">#        else:</span>
<span class="c1">#            raise NotImplementedError(&#39;{0} model not implemented&#39;</span>
<span class="c1">#                                      &#39;&#39;.format(model))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_temp</span><span class="p">[</span><span class="s1">&#39;grtn_y_int&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_zero</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;grtn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;grtn&#39;</span><span class="p">]</span> <span class="o">-</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_model</span><span class="p">(</span><span class="n">col_x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span><span class="p">,</span> <span class="n">col_y</span><span class="o">=</span><span class="s1">&#39;grtn&#39;</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">update_eonr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calc_nrtn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the net return to N. If cost_n_social &gt; 0,</span>
<span class="sd">        _f_qp_theta2 uses actual N uptake data to derive the absolute</span>
<span class="sd">        cost of excess (or net negative) fertilizer (see _best_fit_lin() and</span>
<span class="sd">        _best_fit_exp()). This cost is already in units of $ based on the</span>
<span class="sd">        economic scenario, but keep in mind that it will almost certainly have</span>
<span class="sd">        an intercept other than zero.</span>

<span class="sd">        For example, if more N is taken up than applied, there is a net</span>
<span class="sd">        negative use (-net_use); in terms of dollars, net_use can be divided</span>
<span class="sd">        by the social cost/price of N to get into units of $, which is a unit</span>
<span class="sd">        that can be used with the price ratio R.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">col_x</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">col_y</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quadratic&#39;</span><span class="p">:</span>
<span class="c1">#            f_model = self.models.quadratic</span>
            <span class="n">f_model_theta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">q_theta2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quad_plateau&#39;</span><span class="p">:</span>
<span class="c1">#            f_model = self.models.quad_plateau</span>
            <span class="n">f_model_theta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">qp_theta2</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;crit_x&#39;</span><span class="p">],</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;func = </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">col_x = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">col_y = </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_model_theta2</span><span class="p">,</span>
                          <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">))</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_opt</span><span class="p">(</span><span class="n">f_model_theta2</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                                         <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">f_model_theta2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
        <span class="c1"># if cost_n_social &gt; 0, this will be dif than coefs_grtn[&#39;ss_res&#39;]</span>
        <span class="n">ss_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">popt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">popt</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pcov</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
            <span class="n">b0</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">ufloat</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">theta2</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">ufloat</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">ufloat</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b0</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">correlated_values</span><span class="p">(</span><span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;b0&#39;</span><span class="p">:</span> <span class="n">b0</span><span class="p">,</span>
                <span class="s1">&#39;theta2&#39;</span><span class="p">:</span> <span class="n">theta2</span><span class="p">,</span>
                <span class="s1">&#39;b2&#39;</span><span class="p">:</span> <span class="n">b2</span><span class="p">,</span>
                <span class="s1">&#39;popt&#39;</span><span class="p">:</span> <span class="n">popt</span><span class="p">,</span>
                <span class="s1">&#39;pcov&#39;</span><span class="p">:</span> <span class="n">pcov</span><span class="p">,</span>
                <span class="s1">&#39;ss_res&#39;</span><span class="p">:</span> <span class="n">ss_res</span>
                <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_calc_social_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the slope and intercept for the model describing the added</span>
<span class="sd">        social cost of N</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;resid_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_avail</span><span class="p">]</span> <span class="o">-</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">col_crop_nup</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;social_cost_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;resid_n&#39;</span><span class="p">]</span> <span class="o">*</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_out</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Computing best-fit line between </span><span class="si">{0}</span><span class="s1"> and </span><span class="si">{1}</span><span class="s1">..&#39;</span>
                  <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_best_fit_lin</span><span class="p">(</span><span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_best_fit_exp</span><span class="p">(</span><span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_temp</span><span class="p">[</span><span class="s1">&#39;scn_lin_r2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;lin_r2&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_temp</span><span class="p">[</span><span class="s1">&#39;scn_lin_rmse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;lin_rmse&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_temp</span><span class="p">[</span><span class="s1">&#39;scn_exp_r2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_r2&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_temp</span><span class="p">[</span><span class="s1">&#39;scn_exp_rmse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_social</span><span class="p">[</span><span class="s1">&#39;exp_rmse&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_print_grtn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Prints results of Gross Return to N calculation</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">N Rate vs. Gross Return to N (</span><span class="si">{0}</span><span class="s1"> at $</span><span class="si">{1:.2f}</span><span class="s1"> per </span><span class="si">{2}</span><span class="s1">)&#39;</span>
              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_rtn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_grain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_grain</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;y = </span><span class="si">{0:.5}</span><span class="s1"> + </span><span class="si">{1:.5}</span><span class="s1">x + </span><span class="si">{2:.5}</span><span class="s1">x^2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Critical N Rate: </span><span class="si">{0:.4}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;crit_x&#39;</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum Y (approximate): </span><span class="si">{0:.4}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;max_y&#39;</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adjusted R2: </span><span class="si">{0:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;r2_adj&#39;</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RMSE: </span><span class="si">{0:.1f}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">],</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">unit_rtn</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_print_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Prints results of Economic Optimum N Rate calculation</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">last_run_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;run_n&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">df_ci_last_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;run_n&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">last_run_n</span><span class="p">]</span>
        <span class="n">fert_l</span> <span class="o">=</span> <span class="n">df_ci_last_all</span><span class="p">[</span><span class="n">df_ci_last_all</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.5</span><span class="p">][</span><span class="s1">&#39;pl_l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fert_u</span> <span class="o">=</span> <span class="n">df_ci_last_all</span><span class="p">[</span><span class="n">df_ci_last_all</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.5</span><span class="p">][</span><span class="s1">&#39;pl_u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_ci_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;run_n&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">last_run_n</span><span class="p">)</span> <span class="o">&amp;</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_level</span><span class="p">)]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pl_l</span> <span class="o">=</span> <span class="n">df_ci_last</span><span class="p">[</span><span class="s1">&#39;pl_l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pl_u</span> <span class="o">=</span> <span class="n">df_ci_last</span><span class="p">[</span><span class="s1">&#39;pl_u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">wald_l</span> <span class="o">=</span> <span class="n">df_ci_last</span><span class="p">[</span><span class="s1">&#39;wald_l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">wald_u</span> <span class="o">=</span> <span class="n">df_ci_last</span><span class="p">[</span><span class="s1">&#39;wald_u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_ci</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">boot_l</span> <span class="o">=</span> <span class="n">df_ci_last</span><span class="p">[</span><span class="s1">&#39;boot_l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">boot_u</span> <span class="o">=</span> <span class="n">df_ci_last</span><span class="p">[</span><span class="s1">&#39;boot_u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> optimum N rate (</span><span class="si">{1}</span><span class="s1">): </span><span class="si">{2:.1f}</span><span class="s1"> </span><span class="si">{3}</span><span class="s1"> [</span><span class="si">{4:.1f}</span><span class="s1">, &#39;</span>
              <span class="s1">&#39;</span><span class="si">{5:.1f}</span><span class="s1">] (</span><span class="si">{6:.1f}% c</span><span class="s1">onfidence)&#39;</span>
              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onr_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onr_acr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">unit_nrate</span><span class="p">,</span> <span class="n">pl_l</span><span class="p">,</span> <span class="n">pl_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_level</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum return to N (MRTN): </span><span class="si">{0}{1:.2f}</span><span class="s1"> per </span><span class="si">{2}</span><span class="s1">&#39;</span>
              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_currency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mrtn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_area</span><span class="p">))</span>
<span class="c1">#        print(&#39;Acceptable range in recommended fertilizer rate for {0} {1} &#39;</span>
<span class="c1">#              &#39;{2}: {3:.0f} to {4:.0f} {5}\n&#39;</span>
<span class="c1">#              &#39;&#39;.format(self.location, self.year, self.time_n, fert_l, fert_u,</span>
<span class="c1">#                        self.unit_nrate))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_out</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Profile likelihood confidence bounds (90%): [</span><span class="si">{0:.1f}</span><span class="s1">, &#39;</span>
                  <span class="s1">&#39;</span><span class="si">{1:.1f}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pl_l</span><span class="p">,</span> <span class="n">pl_u</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wald confidence bounds (90%): [</span><span class="si">{0:.1f}</span><span class="s1">, </span><span class="si">{1:.1f}</span><span class="s1">]&#39;</span>
                  <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wald_l</span><span class="p">,</span> <span class="n">wald_u</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bootstrapped confidence bounds (90%): [</span><span class="si">{0:.1f}</span><span class="s1">, </span><span class="si">{1:.1f}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">boot_l</span><span class="p">,</span> <span class="n">boot_u</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_fit_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fits the specified model (EONR.model); if EONR.model is None, fits both</span>
<span class="sd">        then uses the model with the highest R^2 hereafter</span>

<span class="sd">        &lt;col_x (``str``): df column name for x axis</span>
<span class="sd">        &lt;col_y (``str``): df column name for y axis</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">col_x</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">col_y</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;func = </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">col_x = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">col_y = </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;_fit_model() -&gt; _f_quad_plateau&#39;</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">))</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_guess_qp</span><span class="p">(</span><span class="n">rerun</span><span class="o">=</span><span class="n">rerun</span><span class="p">)</span>
        <span class="c1">#  TODO: Add a try/except to catch a bad guess.. or at least warn the</span>
        <span class="c1"># user that the guess is *extremely* sensitive</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rerun</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking quadratic and quadric-plateau models for best &#39;</span>
                  <span class="s1">&#39;fit..&#39;</span><span class="p">)</span>
            <span class="n">model_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">quadratic</span>
            <span class="n">model_qp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">quad_plateau</span>
            <span class="n">popt_q</span><span class="p">,</span> <span class="n">pcov_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_opt</span><span class="p">(</span><span class="n">model_q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                                                 <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">r2_adj_q</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">rmse_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsq</span><span class="p">(</span>
                <span class="n">model_q</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">popt_q</span><span class="p">)</span>
            <span class="n">popt_qp</span><span class="p">,</span> <span class="n">pcov_qp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_opt</span><span class="p">(</span><span class="n">model_qp</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span>
                                                   <span class="n">y</span><span class="p">,</span><span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">r2_adj_qp</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">rmse_qp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsq</span><span class="p">(</span>
                <span class="n">model_qp</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">popt_qp</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Quadratic model r^2: </span><span class="si">{0:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r2_adj_q</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Quadratic-plateau model r^2: </span><span class="si">{0:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r2_adj_qp</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">r2_adj_q</span> <span class="o">&gt;</span> <span class="n">r2_adj_qp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="o">=</span> <span class="s1">&#39;quadratic&#39;</span>
<span class="c1">#                model = self.models.quadratic</span>
<span class="c1">#                popt, pcov = popt_q, pcov_q</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using the quadratic model..&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="o">=</span> <span class="s1">&#39;quad_plateau&#39;</span>
<span class="c1">#                model = self.models.quad_plateau</span>
<span class="c1">#                popt, pcov = popt_qp, pcov_qp</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using the quadratic-plateau model..&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rerun</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Using self.model_temp because it was already determined</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quadratic&#39;</span><span class="p">:</span>
            <span class="n">f_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">quadratic</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quad_plateau&#39;</span><span class="p">:</span>
            <span class="n">f_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">quad_plateau</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> model not implemented&#39;</span>
                                      <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_model</span><span class="p">))</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_opt</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">popt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">popt</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pcov</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
            <span class="n">b0</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">ufloat</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">ufloat</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">ufloat</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">correlated_values</span><span class="p">(</span><span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span><span class="p">)</span>

        <span class="n">crit_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">b1</span><span class="o">.</span><span class="n">n</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">b2</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="n">f_model</span><span class="p">(</span><span class="n">crit_x</span><span class="p">,</span> <span class="n">b0</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">b1</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="n">r2</span><span class="p">,</span> <span class="n">r2_adj</span><span class="p">,</span> <span class="n">ss_res</span><span class="p">,</span> <span class="n">ss_tot</span><span class="p">,</span> <span class="n">rmse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsq</span><span class="p">(</span>
                <span class="n">f_model</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">popt</span><span class="p">)</span>
        <span class="n">aic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_aic</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;gamma&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rerun</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;b0&#39;</span><span class="p">:</span> <span class="n">b0</span><span class="p">,</span>
                    <span class="s1">&#39;b1&#39;</span><span class="p">:</span> <span class="n">b1</span><span class="p">,</span>
                    <span class="s1">&#39;b2&#39;</span><span class="p">:</span> <span class="n">b2</span><span class="p">,</span>
                    <span class="s1">&#39;pcov&#39;</span><span class="p">:</span> <span class="n">pcov</span><span class="p">,</span>
                    <span class="s1">&#39;pval_a&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;pval_b&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;pval_c&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
                    <span class="s1">&#39;r2_adj&#39;</span><span class="p">:</span> <span class="n">r2_adj</span><span class="p">,</span>
                    <span class="s1">&#39;AIC&#39;</span><span class="p">:</span> <span class="n">aic</span><span class="p">,</span>
                    <span class="s1">&#39;BIC&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;max_y&#39;</span><span class="p">:</span> <span class="n">max_y</span><span class="p">,</span>
                    <span class="s1">&#39;crit_x&#39;</span><span class="p">:</span> <span class="n">crit_x</span><span class="p">,</span>
                    <span class="s1">&#39;ss_res&#39;</span><span class="p">:</span> <span class="n">ss_res</span><span class="p">,</span>
                    <span class="s1">&#39;ss_tot&#39;</span><span class="p">:</span> <span class="n">ss_tot</span><span class="p">,</span>
                    <span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">rmse</span>
                    <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;b0&#39;</span><span class="p">:</span> <span class="n">b0</span><span class="p">,</span>
                    <span class="s1">&#39;theta2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;b2&#39;</span><span class="p">:</span> <span class="n">b2</span><span class="p">,</span>
                    <span class="s1">&#39;popt&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;pcov&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;ss_res&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;eonr_bias&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;theta2_social&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;popt_social&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;ss_res_social&#39;</span><span class="p">:</span> <span class="kc">None</span>
                    <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn_primary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;b0&#39;</span><span class="p">:</span> <span class="n">b0</span><span class="p">,</span>
                    <span class="s1">&#39;b1&#39;</span><span class="p">:</span> <span class="n">b1</span><span class="p">,</span>
                    <span class="s1">&#39;b2&#39;</span><span class="p">:</span> <span class="n">b2</span><span class="p">,</span>
                    <span class="s1">&#39;pcov&#39;</span><span class="p">:</span> <span class="n">pcov</span><span class="p">,</span>
                    <span class="s1">&#39;pval_a&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;pval_b&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;pval_c&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
                    <span class="s1">&#39;r2_adj&#39;</span><span class="p">:</span> <span class="n">r2_adj</span><span class="p">,</span>
                    <span class="s1">&#39;AIC&#39;</span><span class="p">:</span> <span class="n">aic</span><span class="p">,</span>
                    <span class="s1">&#39;BIC&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;max_y&#39;</span><span class="p">:</span> <span class="n">max_y</span><span class="p">,</span>
                    <span class="s1">&#39;crit_x&#39;</span><span class="p">:</span> <span class="n">crit_x</span><span class="p">,</span>
                    <span class="s1">&#39;ss_res&#39;</span><span class="p">:</span> <span class="n">ss_res</span><span class="p">,</span>
                    <span class="s1">&#39;ss_tot&#39;</span><span class="p">:</span> <span class="n">ss_tot</span><span class="p">,</span>
                    <span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">rmse</span>
                    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_setup_ncost_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Generates an array for the N cost curve</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;crit_x&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x_max</span><span class="p">:</span>
            <span class="n">num_thresh</span> <span class="o">=</span> <span class="n">n_steps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_thresh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_steps</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;crit_x&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_max</span><span class="p">)))</span>
        <span class="n">step_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x1a</span><span class="p">,</span> <span class="n">ss1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span>
                               <span class="p">((</span><span class="n">x_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_thresh</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">step_size</span><span class="p">)),</span>
                               <span class="n">num</span><span class="o">=</span><span class="n">num_thresh</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x1b</span><span class="p">,</span> <span class="n">ss2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(((</span><span class="n">x_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_thresh</span><span class="p">)</span> <span class="o">*</span> <span class="n">step_size</span><span class="p">)),</span>
                               <span class="n">x_max</span><span class="p">,</span>
                               <span class="n">num</span><span class="o">=</span><span class="n">n_steps</span><span class="o">-</span><span class="n">num_thresh</span><span class="p">,</span>
                               <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x1a</span><span class="p">,</span> <span class="n">x1b</span><span class="p">))</span>
        <span class="n">y_fert_n</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_fert</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">costs_fixed</span>
        <span class="k">return</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y_fert_n</span><span class="p">,</span> <span class="n">x1a</span>  <span class="c1"># x1a used in _setup_grtn_curve()</span>

    <span class="k">def</span> <span class="nf">_setup_grtn_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x1a</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Generates an array for GRTN curve</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span>
                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;crit_x&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;crit_x&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;crit_x&#39;</span><span class="p">]</span> <span class="o">*</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
        <span class="c1"># Find index where all x = max</span>
        <span class="n">y_temp</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span>
                  <span class="p">(</span><span class="n">x1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
                  <span class="p">(</span><span class="n">x1</span><span class="o">*</span><span class="n">x1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
        <span class="n">y_max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_temp</span><span class="p">)</span>
        <span class="n">y2a</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span>
               <span class="p">(</span><span class="n">x1a</span><span class="p">[:</span><span class="n">y_max_idx</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
               <span class="p">(</span><span class="n">x1a</span><span class="p">[:</span><span class="n">y_max_idx</span><span class="p">]</span><span class="o">*</span><span class="n">x1a</span><span class="p">[:</span><span class="n">y_max_idx</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="n">y2b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">n_steps</span><span class="o">-</span><span class="n">y_max_idx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># EONR is past the point of available data, plot last val again</span>
            <span class="n">last_pt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span>
                       <span class="p">(</span><span class="n">x1a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
                       <span class="p">(</span><span class="n">x1a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x1a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
            <span class="n">y2b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">last_pt</span><span class="p">,</span> <span class="n">last_pt</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">n_steps</span><span class="o">-</span><span class="n">y_max_idx</span><span class="p">)</span>
        <span class="n">y_grtn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">y2a</span><span class="p">,</span> <span class="n">y2b</span><span class="p">))</span>

        <span class="c1"># if necessary, modify y_grtn so it has correct number of values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_grtn</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_steps</span><span class="p">:</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_grtn</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_steps</span><span class="p">:</span>
                <span class="n">y_grtn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">y_grtn</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="n">y_max</span><span class="p">]))))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_grtn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_steps</span><span class="p">:</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_grtn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_steps</span><span class="p">:</span>
                <span class="n">y_grtn</span> <span class="o">=</span> <span class="n">y_grtn</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">y_grtn</span>

    <span class="k">def</span> <span class="nf">_solve_eonr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Uses scipy.optimize to find the maximum value of the return curve</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">f_eonr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;theta2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">])</span>
        <span class="n">f_eonr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="c1">#            if self.coefs_social[&#39;lin_r2&#39;] &gt; self.coefs_social[&#39;exp_r2&#39;]:</span>
<span class="c1">#                print(&#39;method 1&#39;)</span>
<span class="c1">#                # subtract only cost of fertilizer</span>
<span class="c1">#                first_order = self.cost_n_fert + self.coefs_social[&#39;lin_mx&#39;]</span>
<span class="c1">#                f_eonr1 = self._modify_poly1d(f_eonr1, 1,</span>
<span class="c1">#                                              f_eonr1.coef[1] - first_order)</span>
<span class="c1">#                f_eonr1 = self._modify_poly1d(f_eonr1, 0,</span>
<span class="c1">#                                              self.coefs_social[&#39;lin_b&#39;])</span>
<span class="c1">#                result = minimize_scalar(-f_eonr1)</span>
<span class="c1">#                self.f_eonr = f_eonr1</span>
<span class="c1">#            else:  # add together the cost of fertilizer and cost of social N</span>
<span class="c1">#                print(&#39;method 2&#39;)</span>
            <span class="n">x_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">minimize_scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">combine_rtn_cost</span><span class="p">,</span>
                                     <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="n">x_max</span><span class="o">+</span><span class="mi">100</span><span class="p">],</span>
                                     <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bounded&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">first_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_fert</span>
            <span class="n">f_eonr2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modify_poly1d</span><span class="p">(</span><span class="n">f_eonr2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">first_order</span><span class="p">)</span>
            <span class="n">f_eonr2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modify_poly1d</span><span class="p">(</span>
                    <span class="n">f_eonr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">costs_fixed</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">minimize_scalar</span><span class="p">(</span><span class="o">-</span><span class="n">f_eonr2</span><span class="p">)</span>
        <span class="c1"># theta2 is EOR (minimum) only if total cost of N increases linearly</span>
        <span class="c1"># at a first order with an intercept of zero..</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mrtn</span> <span class="o">=</span> <span class="o">-</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_theta2_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates a error between EONR and theta2 from _f_qp_theta2</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grtn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quadratic&#39;</span><span class="p">:</span>
<span class="c1">#            f_model = self.models.quadratic</span>
            <span class="n">f_model_theta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">q_theta2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quad_plateau&#39;</span><span class="p">:</span>
<span class="c1">#            f_model = self.models.quad_plateau</span>
            <span class="n">f_model_theta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">qp_theta2</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_opt</span><span class="p">(</span><span class="n">f_model_theta2</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span>
                                         <span class="n">maxfev</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;eonr_bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span>

    <span class="c1">#  Following are functions used in calculating confidence intervals</span>
    <span class="k">def</span> <span class="nf">_bs_statfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">maxfev</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">b0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quadratic&#39;</span><span class="p">:</span>
<span class="c1">#            f_model = self.models.quadratic</span>
            <span class="n">f_model_theta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">q_theta2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quad_plateau&#39;</span><span class="p">:</span>
<span class="c1">#            f_model = self.models.quad_plateau</span>
            <span class="n">f_model_theta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">qp_theta2</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span>
<span class="c1">#        y = self.models.quad_plateau(x, a, b, c) + res</span>
<span class="c1">#        try_n = 0</span>
        <span class="n">popt</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_bs</span><span class="p">(</span><span class="n">f_model_theta2</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                                         <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">maxfev</span> <span class="o">=</span> <span class="mi">10000</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Increasing the maximum number of calls to the function to &#39;</span>
                  <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> before giving up.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxfev</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_bs</span><span class="p">(</span><span class="n">f_model_theta2</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span>
                                             <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_build_df_ci</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Builds a template to store confidence intervals in a dataframe</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df_ci</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;year&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;time_n&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">price_grain</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_fert</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">price_ratio</span><span class="p">,</span>
                                    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                    <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">]],</span>
                             <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;time_n&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;price_grain&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;cost_n_fert&#39;</span><span class="p">,</span> <span class="s1">&#39;cost_n_social&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;price_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;f_stat&#39;</span><span class="p">,</span> <span class="s1">&#39;t_stat&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;wald_l&#39;</span><span class="p">,</span> <span class="s1">&#39;wald_u&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;pl_l&#39;</span><span class="p">,</span> <span class="s1">&#39;pl_u&#39;</span><span class="p">,</span> <span class="s1">&#39;boot_l&#39;</span><span class="p">,</span> <span class="s1">&#39;boot_u&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;opt_method_l&#39;</span><span class="p">,</span> <span class="s1">&#39;opt_method_u&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df_ci</span>

    <span class="k">def</span> <span class="nf">_calc_sse_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the sum of squares across the full set of parameters,</span>
<span class="sd">        solving for theta2</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quadratic&#39;</span><span class="p">:</span>
<span class="c1">#            f_model = self.models.quadratic</span>
            <span class="n">f_model_theta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">q_theta2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quad_plateau&#39;</span><span class="p">:</span>
<span class="c1">#            f_model = self.models.quad_plateau</span>
            <span class="n">f_model_theta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">qp_theta2</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="n">col_x</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Perhaps we should keep in col_x/ytil curve_fit runs..?</span>
        <span class="n">col_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;func = </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">col_x = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">col_y = </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_model_theta2</span><span class="p">,</span>
                          <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">))</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_opt</span><span class="p">(</span><span class="n">f_model_theta2</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span>
                                         <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">f_model_theta2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
        <span class="n">sse_full_theta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sse_full_theta2</span>

    <span class="k">def</span> <span class="nf">_check_progress_pl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">tau_temp</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">f_stat</span><span class="p">,</span>
                           <span class="n">step_size_start</span><span class="p">,</span> <span class="n">tau_delta_flag</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks progress of profile likelihood function and adjusts step</span>
<span class="sd">        size accordingly. Without this function, there is a chance some</span>
<span class="sd">        datasets will take millions of tries if the ci is wide</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tau_temp&#39;</span><span class="p">,</span> <span class="n">tau_temp</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tau&#39;</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;f_stat&#39;</span><span class="p">,</span> <span class="n">f_stat</span><span class="p">)</span>
        <span class="n">tau_delta</span> <span class="o">=</span> <span class="n">tau_temp</span> <span class="o">-</span> <span class="n">tau</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">tau_temp</span> <span class="o">/</span> <span class="n">f_stat</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress</span> <span class="o">&lt;</span> <span class="mf">0.9</span> <span class="ow">and</span> <span class="n">tau_delta</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
            <span class="n">step_size</span> <span class="o">=</span> <span class="n">step_size_start</span>
            <span class="n">step_size</span> <span class="o">*=</span> <span class="mi">1000</span>
            <span class="n">tau_delta_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">progress</span> <span class="o">&lt;</span> <span class="mf">0.9</span> <span class="ow">and</span> <span class="n">tau_delta</span> <span class="o">&lt;</span> <span class="mf">1e-2</span><span class="p">:</span>
            <span class="n">step_size</span> <span class="o">=</span> <span class="n">step_size_start</span>
            <span class="n">step_size</span> <span class="o">*=</span> <span class="mi">100</span>
            <span class="n">tau_delta_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">progress</span> <span class="o">&lt;</span> <span class="mf">0.95</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">step_size</span> <span class="o">=</span> <span class="n">step_size_start</span>
            <span class="n">step_size</span> <span class="o">*=</span> <span class="mi">1000</span>
            <span class="n">tau_delta_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">progress</span> <span class="o">&lt;</span> <span class="mf">0.9</span><span class="p">:</span>
            <span class="n">step_size</span> <span class="o">=</span> <span class="n">step_size_start</span>
            <span class="n">step_size</span> <span class="o">*=</span> <span class="mi">10</span>
            <span class="n">tau_delta_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tau_delta_flag</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">step_size</span> <span class="o">=</span> <span class="n">step_size_start</span>
            <span class="c1"># else keep step size the same</span>
        <span class="k">return</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">tau_delta_flag</span>

    <span class="k">def</span> <span class="nf">_compute_bootstrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">samples_boot</span><span class="o">=</span><span class="mi">9999</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Uses bootstrapping to estimate EONR based on the sampling distribution</span>
<span class="sd">        0) Initialize vector x with residuals - mean</span>
<span class="sd">        1) Sample with replacement from vector x (n = number of initial</span>
<span class="sd">             samples..)</span>
<span class="sd">        2) Calculate the percentile and &quot;bias corrected and accelerated&quot;</span>
<span class="sd">             bootstrapped CIs</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">boot_ci</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;grtn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">boot_ci</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="n">ci</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">statfunction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bs_statfunction</span><span class="p">,</span>
                                   <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="n">samples_boot</span><span class="p">,</span>
                                   <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bca&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unable to compute bootstrap confidence intervals at &#39;</span>
                      <span class="s1">&#39;alpha = </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">boot_ci</span>

    <span class="k">def</span> <span class="nf">_compute_cis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">,</span> <span class="n">bootstrap_ci</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">delta_tstat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">samples_boot</span><span class="o">=</span><span class="mi">9999</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes Wald, Profile Likelihood, and Bootstrap confidence intervals.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">alpha_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_list</span>
        <span class="n">df_ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_df_ci</span><span class="p">()</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">df_ci</span><span class="o">.</span><span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_delta_tstat</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reset from any previous datasets</span>

        <span class="k">if</span> <span class="n">bootstrap_ci</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
<span class="c1">#            df_ci = self._run_bootstrap(df_ci, alpha_list, n_samples=9999)</span>
            <span class="n">pctle_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_alpha_list</span><span class="p">(</span><span class="n">alpha_list</span><span class="p">)</span>
            <span class="n">boot_ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_bootstrap</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">pctle_list</span><span class="p">,</span>
                                              <span class="n">samples_boot</span><span class="o">=</span><span class="n">samples_boot</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">boot_ci</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_list</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
<span class="c1">#        else:</span>
<span class="c1">#            boot_ci = np.insert(boot_ci, [0], [np.nan, np.nan])</span>
        <span class="k">if</span> <span class="n">boot_ci</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_boot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_boot_ci</span><span class="p">(</span><span class="n">boot_ci</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alpha_list</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span>
            <span class="n">f_stat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="n">dfn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dfd</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">t_stat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="c1">#            if level == self.ci_level:</span>
            <span class="n">pl_l</span><span class="p">,</span> <span class="n">pl_u</span><span class="p">,</span> <span class="n">wald_l</span><span class="p">,</span> <span class="n">wald_u</span><span class="p">,</span> <span class="n">opt_method_l</span><span class="p">,</span> <span class="n">opt_method_u</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_likelihood</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">,</span>
                                         <span class="n">delta_tstat</span><span class="o">=</span><span class="n">delta_tstat</span><span class="p">)</span>
<span class="c1">#            else:</span>
<span class="c1">#                pl_l, pl_u, wald_l, wald_u, opt_method_l, opt_method_u =\</span>
<span class="c1">#                        self._get_likelihood(alpha, col_x, col_y, stat=&#39;t&#39;,</span>
<span class="c1">#                                             delta_tstat=False)</span>
            <span class="k">if</span> <span class="n">bootstrap_ci</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">boot_ci</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pctle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_alpha_list</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
                    <span class="n">boot_l</span><span class="p">,</span> <span class="n">boot_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_bootstrap</span><span class="p">(</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="n">pctle</span><span class="p">,</span> <span class="n">samples_boot</span><span class="o">=</span><span class="n">samples_boot</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">boot_l</span> <span class="o">=</span> <span class="n">df_boot</span><span class="p">[</span><span class="n">df_boot</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">alpha</span><span class="p">][</span><span class="s1">&#39;boot_l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">boot_u</span> <span class="o">=</span> <span class="n">df_boot</span><span class="p">[</span><span class="n">df_boot</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">alpha</span><span class="p">][</span><span class="s1">&#39;boot_u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">boot_l</span><span class="p">,</span> <span class="n">boot_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">df_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;year&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;time_n&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">price_grain</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_fert</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">price_ratio</span><span class="p">,</span>
                                    <span class="n">f_stat</span><span class="p">,</span> <span class="n">t_stat</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
                                    <span class="n">wald_l</span><span class="p">,</span> <span class="n">wald_u</span><span class="p">,</span>
                                    <span class="n">pl_l</span><span class="p">,</span> <span class="n">pl_u</span><span class="p">,</span> <span class="n">boot_l</span><span class="p">,</span> <span class="n">boot_u</span><span class="p">,</span>
                                    <span class="n">opt_method_l</span><span class="p">,</span> <span class="n">opt_method_u</span><span class="p">]],</span>
                                  <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
            <span class="n">df_ci</span> <span class="o">=</span> <span class="n">df_ci</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_row</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1">#            if df_row[&#39;level&#39;].values[0] == self.ci_level:</span>
<span class="c1">#                df_ci_last = df_row</span>
<span class="c1">#        if bootstrap_ci is True:</span>
<span class="c1">##            df_ci = self._run_bootstrap(df_ci, alpha_list, n_samples=9999)</span>
<span class="c1">#            pctle_list = self._parse_alpha_list(alpha_list)</span>
<span class="c1">#            df_boot = self._run_bootstrap(pctle_list, n_samples=9999)</span>
<span class="c1">#            df_ci = pd.concat([df_ci, df_boot], axis=1)</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_ci</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;run_n&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span> <span class="o">=</span> <span class="n">df_ci</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_run_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:][</span><span class="s1">&#39;run_n&#39;</span><span class="p">]</span>
            <span class="n">df_ci</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;run_n&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">last_run_n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_ci</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">last_run_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:][</span><span class="s1">&#39;run_n&#39;</span><span class="p">]</span>
<span class="c1">#        self.df_ci_last = self.df_ci[(self.df_ci[&#39;run_n&#39;] == last_run_n) &amp;</span>
<span class="c1">#                                     (self.df_ci[&#39;level&#39;] == self.ci_level)]</span>

    <span class="k">def</span> <span class="nf">_compute_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the residuals of the gross return values and saves to</span>
<span class="sd">        &lt;df_data&gt; for use in the _compute_cis() function (confidence intervals)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">col_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span>
        <span class="n">col_y</span> <span class="o">=</span> <span class="s1">&#39;grtn&#39;</span>
        <span class="n">df_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">col_x</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">col_y</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quadratic&#39;</span><span class="p">:</span>
            <span class="n">f_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">quadratic</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quad_plateau&#39;</span><span class="p">:</span>
            <span class="n">f_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">quad_plateau</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;func = </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">col_x = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">col_y = </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">))</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
<span class="c1">#        print(&#39;popt: {0}&#39;.format(guess))</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_opt</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
<span class="c1">#        if self.base_zero is False:</span>
<span class="c1">#            popt, pcov = self._curve_fit_opt(f_model, x, y,</span>
<span class="c1">#                                             p0=(600, 3, -0.01), info=info)</span>
<span class="c1">#        else:</span>
<span class="c1">#            popt, pcov = self._curve_fit_opt(f_model, x, y,</span>
<span class="c1">#                                             p0=(0, 3, -0.01), info=info)</span>
<span class="c1">#        print(&#39;popt: {0}&#39;.format(popt))  # if same, do we need previous 4 lines?</span>
<span class="c1">#        res = y - self.models.quad_plateau(x, *popt)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">f_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">-=</span> <span class="n">res</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                               <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;grtn_res&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_temp</span> <span class="o">=</span> <span class="n">df_temp</span>
        <span class="n">df_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_data</span><span class="p">,</span> <span class="n">df_temp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span> <span class="o">=</span> <span class="n">df_data</span>

    <span class="k">def</span> <span class="nf">_compute_wald</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">s2c</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the Wald confidence intervals for a range of alphas. &lt;n&gt; and</span>
<span class="sd">        &lt;p&gt; are used to determine tau (from the t-statistic)</span>
<span class="sd">        From page 104 - 105 (Gallant, 1987)</span>

<span class="sd">        &lt;n (``int``): number of samples</span>
<span class="sd">        &lt;p (``int``): number of parameters</span>
<span class="sd">        &lt;s2c (``float``): the variance of the EONR value(notation from Gallant, 1987)</span>

<span class="sd">        s2 = SSE / (n - p)</span>
<span class="sd">        c = s2c / s2</span>
<span class="sd">        tau * (s2 * c)**(0.5)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">s2c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">s2c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;theta2_social&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s2c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;theta2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># Wald should use t_stat</span>
        <span class="n">ci_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span> <span class="o">-</span> <span class="p">(</span><span class="n">tau</span> <span class="o">*</span> <span class="n">s2c</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="n">ci_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span> <span class="o">+</span> <span class="p">(</span><span class="n">tau</span> <span class="o">*</span> <span class="n">s2c</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span>

    <span class="k">def</span> <span class="nf">_get_guess_qp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets a reasonable guess for p0 of curve_fit function</span>
<span class="sd">        * Note that these guesses are *extremely* sensitive to the result that</span>
<span class="sd">        will be generated from the curve_fit() function. The parameter guesses</span>
<span class="sd">        are set realistically based on yield response to N in MN, but there is</span>
<span class="sd">        no guarantee it will work for all datasets..</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">rerun</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rerun</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.03</span><span class="p">)</span>
        <span class="c1"># if rerun is True, don&#39;t we already know the beta1 and beta2 params?</span>
        <span class="k">elif</span> <span class="n">rerun</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_zero</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">b0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">guess</span>

    <span class="k">class</span> <span class="nc">_pl_steps_init</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Initializes variables required for _get_pl_steps()&#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta2_start</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">tau_start</span><span class="p">,</span>
                     <span class="n">step_size</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">sse_full</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">,</span>
                     <span class="n">cost_n_social</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theta2_start</span> <span class="o">=</span> <span class="n">theta2_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">side</span> <span class="o">=</span> <span class="n">side</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tau_start</span> <span class="o">=</span> <span class="n">tau_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_size</span> <span class="o">=</span> <span class="n">step_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">guess</span> <span class="o">=</span> <span class="n">guess</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sse_full</span> <span class="o">=</span> <span class="n">sse_full</span>
<span class="c1">#            self.col_x = col_x</span>
<span class="c1">#            self.col_y = col_y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">=</span> <span class="n">cost_n_social</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please choose either &quot;upper&quot; or &quot;lower&quot; for &lt;side&gt; of &#39;</span>
                   <span class="s1">&#39;confidence interval to compute.&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">side</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">],</span> <span class="n">msg</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_stat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="n">dfn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">dfd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># ppf is inv of cdf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_stat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
<span class="c1">#            f_stat = stats.f.ppf(1-alpha, dfn=q, dfd=n-p)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s2</span> <span class="o">=</span> <span class="n">sse_full</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theta2</span> <span class="o">=</span> <span class="n">theta2_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_size_start</span> <span class="o">=</span> <span class="n">step_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tau_delta_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">str_func</span> <span class="o">=</span> <span class="s1">&#39;_get_likelihood() -&gt; _f_qp_theta2&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;func = </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">col_x = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">col_y = </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">str_func</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_pl_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta2_start</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">tau_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sse_full</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the profile-likelihood confidence values by incrementing by</span>
<span class="sd">        &lt;step_size&gt; until tau and test statistic are within &lt;epsilon&gt;</span>
<span class="sd">        &lt;theta2_start&gt;: starting point of theta2 (should be set to maximum</span>
<span class="sd">            likelihood value)</span>
<span class="sd">        &lt;alpha&gt;: the significance level to compute the likelihood for</span>
<span class="sd">        &lt;x&gt; and &lt;y&gt;: the x and y data that likelihood should be computed for</span>
<span class="sd">        &lt;side&gt;: The side of the confidence interval to compute the likelihood</span>
<span class="sd">            for - should be either &quot;upper&quot; or &quot;lower&quot; (dtype = str)</span>

<span class="sd">        Uses &lt;alpha&gt; to calculate the inverse of the cdf (cumulative</span>
<span class="sd">        distribution function) of the F statistic. The T statistic can be used</span>
<span class="sd">        as well (they will give the same result).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quadratic&#39;</span><span class="p">:</span>
<span class="c1">#            f_model = self.models.quadratic</span>
            <span class="n">f_model_theta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">q_theta2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quad_plateau&#39;</span><span class="p">:</span>
<span class="c1">#            f_model = self.models.quad_plateau</span>
            <span class="n">f_model_theta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">qp_theta2</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;crit_x&#39;</span><span class="p">],</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sse_full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sse_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_sse_full</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;f_stat&#39;</span><span class="p">,</span> <span class="s1">&#39;t_stat&#39;</span><span class="p">])</span>
        <span class="n">col_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span>
        <span class="n">col_y</span> <span class="o">=</span> <span class="s1">&#39;grtn&#39;</span>
        <span class="n">cost_n_social</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span>
        <span class="c1"># Second, call like_init() class to itialize the get_likelihood() func</span>
        <span class="n">li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pl_steps_init</span><span class="p">(</span>
                <span class="n">theta2_start</span><span class="o">=</span><span class="n">theta2_start</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span>
                <span class="n">tau_start</span><span class="o">=</span><span class="n">tau_start</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span>
                <span class="n">guess</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">sse_full</span><span class="o">=</span><span class="n">sse_full</span><span class="p">,</span> <span class="n">col_x</span><span class="o">=</span><span class="n">col_x</span><span class="p">,</span>
                <span class="n">col_y</span><span class="o">=</span><span class="n">col_y</span><span class="p">,</span> <span class="n">cost_n_social</span><span class="o">=</span><span class="n">cost_n_social</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
            <span class="n">crit_stat</span> <span class="o">=</span> <span class="n">li</span><span class="o">.</span><span class="n">t_stat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">crit_stat</span> <span class="o">=</span> <span class="n">li</span><span class="o">.</span><span class="n">f_stat</span>
        <span class="c1"># Third, minimize the difference between tau and the test statistic</span>
        <span class="c1"># call, anything in _pl_steps_init() using li.&lt;variable&gt;</span>
        <span class="c1"># e.g., li.tau will get you the &lt;tau&gt; variable</span>
        <span class="c1"># Rule of thumb: if saved in both EONR and _pl_steps_init, use</span>
        <span class="c1"># variable from EONR; if passed directly to _get_pl_steps(), use the</span>
        <span class="c1"># variable directly</span>

        <span class="c1"># Testing quadratic model 8/7/2019</span>

<span class="c1">#        b0 = my_eonr.coefs_grtn[&#39;b0&#39;].n</span>
<span class="c1">#        b1 = my_eonr.coefs_grtn[&#39;b1&#39;].n</span>
<span class="c1">#        b2 = my_eonr.coefs_grtn[&#39;b2&#39;].n</span>
<span class="c1">#        theta2 = my_eonr.coefs_nrtn[&#39;theta2&#39;].n</span>
<span class="c1">#</span>
<span class="c1">#        y1 = my_eonr.models.quadratic(x, b0, b1, b2)</span>
<span class="c1">#        y2 = my_eonr.models.q_theta2(x, b0, theta2, b2)</span>
<span class="c1">#</span>
<span class="c1">#        sns.scatterplot(x, y1)</span>
<span class="c1">#        sns.scatterplot(x, y2)</span>

        <span class="k">while</span> <span class="n">li</span><span class="o">.</span><span class="n">tau</span> <span class="o">&lt;</span> <span class="n">crit_stat</span><span class="p">:</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_runtime</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">b2</span><span class="p">:</span> <span class="n">f_model_theta2</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">li</span><span class="o">.</span><span class="n">theta2</span><span class="p">,</span> <span class="n">b2</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                    <span class="n">guess</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">li</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">popt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">popt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">popt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">li</span><span class="o">.</span><span class="n">theta2</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">f_model_theta2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
                <span class="n">sse_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">tau_temp_f</span> <span class="o">=</span> <span class="p">((</span><span class="n">sse_res</span> <span class="o">-</span> <span class="n">sse_full</span><span class="p">)</span> <span class="o">/</span> <span class="n">li</span><span class="o">.</span><span class="n">q</span><span class="p">)</span> <span class="o">/</span> <span class="n">li</span><span class="o">.</span><span class="n">s2</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tau_temp_t</span> <span class="o">=</span> <span class="n">tau_temp_f</span><span class="o">**</span><span class="mf">0.5</span>
                    <span class="k">except</span> <span class="ne">RuntimeWarning</span><span class="p">:</span>
                        <span class="n">tau_temp_t</span> <span class="o">=</span> <span class="mf">1e-6</span>  <span class="c1"># when 0, we get an overflow error</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

<span class="c1">#                    print(err)</span>
<span class="c1">#                tau_temp_t = tau_temp_f**0.5</span>
                <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>  <span class="c1"># Be SURE tau is compared to correct stat!</span>
                    <span class="n">tau_temp</span> <span class="o">=</span> <span class="n">tau_temp_t</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tau_temp</span> <span class="o">=</span> <span class="n">tau_temp_f</span>
                <span class="c1"># The following is used in Hernandez and Mulla (2008), but adds</span>
                <span class="c1"># an unnecessary complexity/confusion to testing significance</span>
<span class="c1">#                tau_temp = abs(li.theta2 - self.eonr)**0.5 * tau_temp_f**0.5</span>
<span class="c1">#            print(alpha)</span>
<span class="c1">#            print(tau_temp - crit_stat)</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:.1f}</span><span class="s1">% </span><span class="si">{1}</span><span class="s1"> profile likelihood failed to converge &#39;</span>
                      <span class="s1">&#39;after </span><span class="si">{2}</span><span class="s1"> iterations. Stopping calculation and using &#39;</span>
                      <span class="s1">&#39;</span><span class="si">{3:.1f}</span><span class="s1"> </span><span class="si">{4}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">side</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
                                           <span class="n">count</span><span class="p">,</span> <span class="n">li</span><span class="o">.</span><span class="n">theta2</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">unit_nrate</span><span class="p">))</span>
                <span class="n">tau_temp_f</span> <span class="o">=</span> <span class="n">li</span><span class="o">.</span><span class="n">f_stat</span>
                <span class="n">tau_temp_t</span> <span class="o">=</span> <span class="n">li</span><span class="o">.</span><span class="n">t_stat</span>
                <span class="n">li</span><span class="o">.</span><span class="n">stop_flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">theta_same</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">theta_same</span><span class="p">,</span> <span class="n">li</span><span class="o">.</span><span class="n">f_stat</span><span class="p">,</span> <span class="n">li</span><span class="o">.</span><span class="n">t_stat</span><span class="p">]],</span>
                                   <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;f_stat&#39;</span><span class="p">,</span> <span class="s1">&#39;t_stat&#39;</span><span class="p">])</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">break</span>  <span class="c1"># break out of while loop</span>
            <span class="k">elif</span> <span class="n">popt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:.1f}</span><span class="s1">% </span><span class="si">{1}</span><span class="s1"> profile likelihood failed to find optimal &#39;</span>
                      <span class="s1">&#39;parameters. Stopping calculation.&#39;</span>
                      <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">side</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()))</span>
                <span class="n">tau_temp_f</span> <span class="o">=</span> <span class="n">li</span><span class="o">.</span><span class="n">f_stat</span>
                <span class="n">tau_temp_t</span> <span class="o">=</span> <span class="n">li</span><span class="o">.</span><span class="n">t_stat</span>
                <span class="n">li</span><span class="o">.</span><span class="n">stop_flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">theta_rec</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">theta_rec</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">theta_rec</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">theta_rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">theta_rec</span><span class="p">,</span>  <span class="n">li</span><span class="o">.</span><span class="n">f_stat</span><span class="p">,</span> <span class="n">li</span><span class="o">.</span><span class="n">t_stat</span><span class="p">]],</span>
                                   <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;f_stat&#39;</span><span class="p">,</span> <span class="s1">&#39;t_stat&#39;</span><span class="p">])</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">break</span>  <span class="c1"># break out of while loop</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">li</span><span class="o">.</span><span class="n">theta2</span><span class="p">,</span> <span class="n">tau_temp_f</span><span class="p">,</span> <span class="n">tau_temp_t</span><span class="p">]],</span>
                                   <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;f_stat&#39;</span><span class="p">,</span> <span class="s1">&#39;t_stat&#39;</span><span class="p">])</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c1">#            if count &gt; 3:</span>
<span class="c1">#                step_size, li.tau_delta_flag = self._check_progress_pl(</span>
<span class="c1">#                        step_size, tau_temp, li.tau, crit_stat,</span>
<span class="c1">#                        li.step_size_start, li.tau_delta_flag, count)</span>
            <span class="k">if</span> <span class="n">side</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;upper&#39;</span><span class="p">:</span>
                <span class="n">li</span><span class="o">.</span><span class="n">theta2</span> <span class="o">+=</span> <span class="n">step_size</span>
            <span class="k">elif</span> <span class="n">side</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;lower&#39;</span><span class="p">:</span>
                <span class="n">li</span><span class="o">.</span><span class="n">theta2</span> <span class="o">-=</span> <span class="n">step_size</span>
            <span class="n">li</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau_temp</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># start over, reducing step size</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pl_steps</span><span class="p">(</span>
                    <span class="n">theta2_start</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">tau_start</span><span class="o">=</span><span class="n">tau_start</span><span class="p">,</span>
                    <span class="n">step_size</span><span class="o">=</span><span class="p">(</span><span class="n">step_size</span><span class="o">/</span><span class="mi">10</span><span class="p">),</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                    <span class="n">sse_full</span><span class="o">=</span><span class="n">sse_full</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">li</span><span class="o">.</span><span class="n">stop_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># If we had to stop calculation..</span>
            <span class="k">pass</span>  <span class="c1"># stop trying to compute profile-likelihood</span>
<span class="c1">#         if CI is moving faster than epsilon</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">:</span>
        <span class="c1"># Can&#39;t stop when within x of epsilon because sometimes convergence</span>
        <span class="c1"># isn&#39;t reached</span>
<span class="c1">#        elif abs(tau_temp - crit_stat) &gt; epsilon:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># At this point, we could get stuck in a loop if we never make any</span>
            <span class="c1"># headway on closing in on epsilon</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
                <span class="n">tau_start</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;t_stat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tau_start</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;f_stat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pl_steps</span><span class="p">(</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span>
                    <span class="n">tau_start</span><span class="o">=</span><span class="n">tau_start</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="p">(</span><span class="n">step_size</span><span class="o">/</span><span class="mi">10</span><span class="p">),</span>
                    <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">sse_full</span><span class="o">=</span><span class="n">sse_full</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">,</span>
                    <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1">#</span>
<span class="c1">#            boot_l, boot_u = self._compute_bootstrap(alpha, n_samples=5000)</span>
<span class="c1">#        theta2_out = df[&#39;theta&#39;].iloc[-2:].mean()</span>
<span class="c1">#        tau_out = df[&#39;f_stat&#39;].iloc[-2:].mean()</span>
        <span class="n">theta2_out</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tau_out</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;t_stat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">theta2_out</span><span class="p">,</span> <span class="n">tau_out</span><span class="p">,</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_run_minimize_pl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">theta2_opt</span><span class="p">,</span> <span class="n">pl_guess</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span>
                         <span class="n">side</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">pl_guess_init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Runs the minimize function making sure the result is suitable/as</span>
<span class="sd">        expected for the profile likelihood</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">pl_guess_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pl_guess_init</span> <span class="o">=</span> <span class="n">pl_guess</span>
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;lower&#39;</span><span class="p">:</span>
            <span class="n">initial_guess</span> <span class="o">=</span> <span class="n">theta2_opt</span> <span class="o">-</span> <span class="n">pl_guess</span>
        <span class="k">elif</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;upper&#39;</span><span class="p">:</span>
            <span class="n">initial_guess</span> <span class="o">=</span> <span class="n">theta2_opt</span> <span class="o">+</span> <span class="n">pl_guess</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">initial_guess</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
<span class="c1">#            print(result)</span>
        <span class="k">if</span> <span class="n">pl_guess</span> <span class="o">&gt;</span> <span class="mi">800</span><span class="p">:</span>
            <span class="n">pl_out</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_minimize_pl</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">theta2_opt</span><span class="p">,</span>
                                         <span class="n">pl_guess</span><span class="o">*</span><span class="mf">1.05</span><span class="p">,</span>
                                         <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                         <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span>
                                         <span class="n">pl_guess_init</span><span class="o">=</span><span class="n">pl_guess_init</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;lower&#39;</span><span class="p">:</span>
<span class="c1">#            if result.x[0] &gt; self.eonr:</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">theta2_opt</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_minimize_pl</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">theta2_opt</span><span class="p">,</span>
                                             <span class="n">pl_guess</span><span class="o">*</span><span class="mf">1.05</span><span class="p">,</span>
                                             <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                             <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span>
                                             <span class="n">pl_guess_init</span><span class="o">=</span><span class="n">pl_guess_init</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pl_out</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;upper&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">theta2_opt</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_minimize_pl</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">theta2_opt</span><span class="p">,</span>
                                             <span class="n">pl_guess</span><span class="o">*</span><span class="mf">1.05</span><span class="p">,</span>
                                             <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                             <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span>
                                             <span class="n">pl_guess_init</span><span class="o">=</span><span class="n">pl_guess_init</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pl_out</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">#        else:  # finally, return result</span>
<span class="c1">#            pl_out = result.x[0]</span>
        <span class="k">return</span> <span class="n">pl_out</span>

    <span class="k">def</span> <span class="nf">_get_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">,</span>
                        <span class="n">last_ci</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">delta_tstat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the profile liklihood confidence values using the sum of</span>
<span class="sd">        squares (see Gallant (1987), p. 107)</span>
<span class="sd">        &lt;alpha&gt;: the significance level to compute the likelihood for</span>
<span class="sd">        &lt;x&gt; and &lt;y&gt;: the x and y data that likelihood should computed for</span>

<span class="sd">        Uses &lt;alpha&gt; to calculate the inverse of the cdf (cumulative</span>
<span class="sd">        distribution function) of the F statistic. The T statistic can be used</span>
<span class="sd">        as well (they will give the same result).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># First, initialize variables</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_x</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_y</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="n">sse_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_sse_full</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># number of params being checked (held constant)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
        <span class="n">f_stat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="n">dfn</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">dfd</span><span class="o">=</span><span class="n">n</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># ppf is inv of cdf</span>
        <span class="n">t_stat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">sse_full</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>  <span class="c1"># variance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">str_func</span> <span class="o">=</span> <span class="s1">&#39;_get_likelihood() -&gt; _f_qp_theta2&#39;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;func = </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">col_x = </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">col_y = </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_func</span><span class="p">,</span> <span class="n">col_x</span><span class="p">,</span> <span class="n">col_y</span><span class="p">))</span>
        <span class="c1"># Second, minimize the difference between tau and the test statistic</span>
        <span class="c1"># call, anything in _get_likelihood_init() using li.&lt;variable&gt;</span>
        <span class="c1"># e.g., li.tau will get you the &lt;tau&gt; variable</span>
        <span class="c1"># Rule of thumb: if saved in both EONR and _get_likelihood_init, use</span>
        <span class="c1"># variable from EONR; if passed directly to _get_likelihood(), use the</span>
        <span class="c1"># variable directly</span>

        <span class="k">def</span> <span class="nf">_f_like_opt</span><span class="p">(</span><span class="n">theta2</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Function for scipy.optimize.newton() to optimize (find the minimum)</span>
<span class="sd">            of the difference between tau and the test statistic. This function</span>
<span class="sd">            returns &lt;dif&gt;, which will equal zero when the likelihood ratio is</span>
<span class="sd">            exactly equal to the test statistic (e.g., t-test or f-test)</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quadratic&#39;</span><span class="p">:</span>
    <span class="c1">#            f_model = self.models.quadratic</span>
                <span class="n">f_model_theta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">q_theta2</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span> <span class="ow">is</span> <span class="s1">&#39;quad_plateau&#39;</span><span class="p">:</span>
    <span class="c1">#            f_model = self.models.quad_plateau</span>
                <span class="n">f_model_theta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">qp_theta2</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curve_fit_runtime</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">b2</span><span class="p">:</span> <span class="n">f_model_theta2</span><span class="p">(</span>
                                <span class="n">x</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">b2</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="n">maxfev</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">popt</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">pcov</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="si">{1}</span><span class="se">\n</span><span class="s1">Alpha: </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">alpha</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">popt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">popt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">popt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">f_model_theta2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
                <span class="n">sse_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">tau_temp_f</span> <span class="o">=</span> <span class="p">((</span><span class="n">sse_res</span> <span class="o">-</span> <span class="n">sse_full</span><span class="p">)</span> <span class="o">/</span> <span class="n">q</span><span class="p">)</span> <span class="o">/</span> <span class="n">s2</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tau_temp_t</span> <span class="o">=</span> <span class="n">tau_temp_f</span><span class="o">**</span><span class="mf">0.5</span>
                    <span class="k">except</span> <span class="ne">RuntimeWarning</span><span class="p">:</span>
                        <span class="n">tau_temp_t</span> <span class="o">=</span> <span class="mf">1e-6</span>  <span class="c1"># when 0, we get an overflow error</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>  <span class="c1"># Be SURE tau is compared to correct stat!</span>
                    <span class="n">tau_temp</span> <span class="o">=</span> <span class="n">tau_temp_t</span>
                    <span class="n">crit_stat</span> <span class="o">=</span> <span class="n">t_stat</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tau_temp</span> <span class="o">=</span> <span class="n">tau_temp_f</span>
                    <span class="n">crit_stat</span> <span class="o">=</span> <span class="n">f_stat</span>
                <span class="n">dif</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">crit_stat</span> <span class="o">-</span> <span class="n">tau_temp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">popt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dif</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">dif</span>

        <span class="k">def</span> <span class="nf">_delta_tstat</span><span class="p">(</span><span class="n">theta2_opt</span><span class="p">,</span> <span class="n">pl_l</span><span class="p">,</span> <span class="n">pl_u</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Executes _f_like_opt() for a range of N rates/theta2 values</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">pl_l</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                <span class="n">theta2_l</span> <span class="o">=</span> <span class="n">theta2_opt</span><span class="o">-</span><span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theta2_l</span> <span class="o">=</span> <span class="n">theta2_opt</span> <span class="o">-</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">theta2_opt</span><span class="o">-</span><span class="n">pl_l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pl_u</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                <span class="n">theta2_u</span> <span class="o">=</span> <span class="n">theta2_opt</span><span class="o">+</span><span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theta2_u</span> <span class="o">=</span> <span class="n">theta2_opt</span> <span class="o">+</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">theta2_opt</span><span class="o">-</span><span class="n">pl_u</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
            <span class="n">theta2_hats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">theta2_l</span><span class="p">,</span> <span class="n">theta2_u</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
            <span class="n">dif_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#            level_list = []</span>
            <span class="k">for</span> <span class="n">theta2_hat</span> <span class="ow">in</span> <span class="n">theta2_hats</span><span class="p">:</span>
                <span class="n">dif_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_f_like_opt</span><span class="p">(</span><span class="n">theta2_hat</span><span class="p">))</span>
<span class="c1">#                level_list.append(1-alpha)</span>

            <span class="n">df_delta_tstat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rate_n&#39;</span><span class="p">:</span> <span class="n">theta2_hats</span><span class="p">,</span>
                                                <span class="s1">&#39;delta_tstat&#39;</span><span class="p">:</span> <span class="n">dif_list</span><span class="p">,</span>
                                                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">df_delta_tstat</span>

        <span class="k">def</span> <span class="nf">_check_convergence</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">theta2_opt</span><span class="p">,</span> <span class="n">pl_guess</span><span class="p">,</span> <span class="n">pl_l</span><span class="p">,</span> <span class="n">pl_u</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span>
                               <span class="n">thresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Check initial guess to see if delta_tau is close to zero - if not,</span>
<span class="sd">            redo with another intitial guess.</span>

<span class="sd">            Parameters</span>
<span class="sd">            thresh (float): tau(theta_2) threshold; anything greater than this</span>
<span class="sd">                is considered a poor fit, probably due to finding a local</span>
<span class="sd">                minimum.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">pl_l</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Upper </span><span class="si">{0:.2f}</span><span class="s1"> profile-likelihood CI may not have &#39;</span>
                      <span class="s1">&#39;optimized..&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
                <span class="n">pl_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">elif</span> <span class="n">f</span><span class="p">(</span><span class="n">pl_l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">:</span>
                <span class="n">guess_l</span> <span class="o">=</span> <span class="n">theta2_opt</span> <span class="o">-</span> <span class="p">(</span><span class="n">pl_guess</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">pl_l_reduced</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">guess_l</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
                <span class="n">guess_l</span> <span class="o">=</span> <span class="n">theta2_opt</span> <span class="o">-</span> <span class="p">(</span><span class="n">pl_guess</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">pl_l_increased</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">guess_l</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">pl_l_reduced</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">f</span><span class="p">(</span><span class="n">pl_l</span><span class="p">):</span>
                    <span class="n">pl_l</span> <span class="o">=</span> <span class="n">pl_l_reduced</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">f</span><span class="p">(</span><span class="n">pl_l_increased</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">f</span><span class="p">(</span><span class="n">pl_l</span><span class="p">):</span>
                    <span class="n">pl_l</span> <span class="o">=</span> <span class="n">pl_l_increased</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Lower </span><span class="si">{0:.2f}</span><span class="s1"> profile-likelihood CI may not have &#39;</span>
                          <span class="s1">&#39;optimized..&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">pl_u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Upper </span><span class="si">{0:.2f}</span><span class="s1"> profile-likelihood CI may not have &#39;</span>
                      <span class="s1">&#39;optimized..&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
                <span class="n">pl_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">elif</span> <span class="n">f</span><span class="p">(</span><span class="n">pl_u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">:</span>
                <span class="n">guess_u</span> <span class="o">=</span> <span class="n">theta2_opt</span> <span class="o">+</span> <span class="p">(</span><span class="n">pl_guess</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">pl_u_reduced</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">guess_u</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
                <span class="n">guess_u</span> <span class="o">=</span> <span class="n">theta2_opt</span> <span class="o">+</span> <span class="p">(</span><span class="n">pl_guess</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">pl_u_increased</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">guess_u</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">pl_u_reduced</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">f</span><span class="p">(</span><span class="n">pl_u</span><span class="p">):</span>
                    <span class="n">pl_u</span> <span class="o">=</span> <span class="n">pl_u_reduced</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">f</span><span class="p">(</span><span class="n">pl_u_increased</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">f</span><span class="p">(</span><span class="n">pl_u</span><span class="p">):</span>
                    <span class="n">pl_u</span> <span class="o">=</span> <span class="n">pl_u_increased</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Upper </span><span class="si">{0:.2f}</span><span class="s1"> profile-likelihood CI may not have &#39;</span>
                          <span class="s1">&#39;optimized..&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">pl_l</span><span class="p">,</span> <span class="n">pl_u</span>

<span class="c1">#        popt, pcov = self._curve_fit_opt(self._f_qp_theta2, x, y, p0=guess, maxfev=800, info=info)</span>
        <span class="n">wald_l</span><span class="p">,</span> <span class="n">wald_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_wald</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">pl_guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">wald_u</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">)</span>  <span class="c1"># Adjust +/- init guess based on Wald</span>
        <span class="n">theta2_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;eonr_bias&#39;</span><span class="p">]</span>
        <span class="n">theta2_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span> <span class="o">+</span> <span class="n">theta2_bias</span>  <span class="c1"># check if this should add the 2</span>

        <span class="c1"># Lower CI: uses the Nelder-Mead algorithm</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span>
        <span class="n">pl_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_minimize_pl</span><span class="p">(</span><span class="n">_f_like_opt</span><span class="p">,</span> <span class="n">theta2_opt</span><span class="p">,</span> <span class="n">pl_guess</span><span class="p">,</span>
                                     <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">pl_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_minimize_pl</span><span class="p">(</span><span class="n">_f_like_opt</span><span class="p">,</span> <span class="n">theta2_opt</span><span class="p">,</span> <span class="n">pl_guess</span><span class="p">,</span>
                                     <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">)</span>
        <span class="n">pl_l</span><span class="p">,</span> <span class="n">pl_u</span> <span class="o">=</span> <span class="n">_check_convergence</span><span class="p">(</span><span class="n">_f_like_opt</span><span class="p">,</span> <span class="n">theta2_opt</span><span class="p">,</span> <span class="n">pl_guess</span><span class="p">,</span>
                                        <span class="n">pl_l</span><span class="p">,</span> <span class="n">pl_u</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
<span class="c1">#        if pl_l is not None:</span>
<span class="c1">#            pl_l += theta2_bias</span>
<span class="c1">#        if pl_u is not None:</span>
<span class="c1">#            pl_u += theta2_bias</span>
<span class="c1">#        if pl_l is None:</span>
<span class="c1">#            pl_l = np.nan</span>
<span class="c1">#        if pl_u is None:</span>
<span class="c1">#            pl_u = np.nan</span>
        <span class="k">if</span> <span class="n">pl_l</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span> <span class="ow">or</span> <span class="n">pl_u</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">:</span>  <span class="c1"># can&#39;t trust the data</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Profile-likelihood calculations are not realistic: &#39;</span>
                  <span class="s1">&#39;[</span><span class="si">{0:.1f}</span><span class="s1">, </span><span class="si">{1:.1f}</span><span class="s1">] setting to NaN&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pl_l</span><span class="p">,</span> <span class="n">pl_u</span><span class="p">))</span>
            <span class="n">pl_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">pl_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="c1">#  TODO: this will still add CIs to df_ci after the CI falls</span>
            <span class="c1">#  above/below the EONR. Could assume a uniform distribution and</span>
            <span class="c1">#  add this to theta2_bias for subsequent calculations. It seems</span>
            <span class="c1">#  as if theta2_bias changed from when it was set in coefs_nrtn:</span>
            <span class="c1">#  perhaps it should be recalculated</span>
        <span class="k">if</span> <span class="n">delta_tstat</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">df_temp</span> <span class="o">=</span> <span class="n">_delta_tstat</span><span class="p">(</span><span class="n">theta2_opt</span><span class="p">,</span> <span class="n">pl_l</span><span class="p">,</span> <span class="n">pl_u</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_delta_tstat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_delta_tstat</span> <span class="o">=</span> <span class="n">df_temp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_delta_tstat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_delta_tstat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_temp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pl_l</span><span class="p">,</span> <span class="n">pl_u</span><span class="p">,</span> <span class="n">wald_l</span><span class="p">,</span> <span class="n">wald_u</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">method</span>

    <span class="k">def</span> <span class="nf">_handle_no_ci</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If critical x is greater than the max N rate, don&#39;t calculate</span>
<span class="sd">        confidence intervals, but fill out df_ci with Wald CIs only</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df_ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_df_ci</span><span class="p">()</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_list</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span><span class="p">])</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
            <span class="n">wald_l</span><span class="p">,</span> <span class="n">wald_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_wald</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">f_stat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="n">dfn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dfd</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">t_stat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">df_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;year&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;time_n&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">price_grain</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_fert</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">price_ratio</span><span class="p">,</span>
                                    <span class="n">f_stat</span><span class="p">,</span> <span class="n">t_stat</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
                                    <span class="n">wald_l</span><span class="p">,</span> <span class="n">wald_u</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">]],</span>
                                  <span class="n">columns</span><span class="o">=</span><span class="n">df_ci</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">df_ci</span> <span class="o">=</span> <span class="n">df_ci</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_row</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#        boot_ci = [None] * ((len(self.ci_list) * 2))</span>
<span class="c1">#        boot_ci = [self.eonr, self.eonr] + list(boot_ci)</span>
<span class="c1">#        df_boot = self._parse_boot_ci(boot_ci)</span>
<span class="c1">#        df_ci = pd.concat([df_ci, df_boot], axis=1)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_ci</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;run_n&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span> <span class="o">=</span> <span class="n">df_ci</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_run_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:][</span><span class="s1">&#39;run_n&#39;</span><span class="p">]</span>
            <span class="n">df_ci</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;run_n&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">last_run_n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_ci</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">last_run_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:][</span><span class="s1">&#39;run_n&#39;</span><span class="p">]</span>
<span class="c1">#        self.df_ci_last = self.df_ci[(self.df_ci[&#39;run_n&#39;] == last_run_n) &amp;</span>
<span class="c1">#                                     (self.df_ci[&#39;level&#39;] == self.ci_level)]</span>

    <span class="k">def</span> <span class="nf">_modify_poly1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">new_val</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Modifies a poly1d object, and returns the modifed object.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">idx</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;Choose idx of 1, 2, or 3.&#39;</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">f_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">([</span><span class="n">new_val</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">f_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">new_val</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">f_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>  <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_val</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">f_new</span>

    <span class="k">def</span> <span class="nf">_parse_alpha_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates a lower and upper percentile from a list of alpha values. The</span>
<span class="sd">        lower is (alpha / 2) and upper is (1 - (alpha / 2)). Required for</span>
<span class="sd">        scikits-bootstrap</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">alpha_pctle</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">alpha</span><span class="p">:</span>
                <span class="n">pctle_l</span> <span class="o">=</span> <span class="n">item</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">pctle_u</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">item</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">alpha_pctle</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">pctle_l</span><span class="p">,</span> <span class="n">pctle_u</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pctle_l</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">pctle_u</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">alpha_pctle</span> <span class="o">=</span> <span class="p">[</span><span class="n">pctle_l</span><span class="p">,</span> <span class="n">pctle_u</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">alpha_pctle</span>

    <span class="k">def</span> <span class="nf">_parse_boot_ci</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boot_ci</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parses a list of values by separating into pairs and where the first</span>
<span class="sd">        item gets assigned to column 1 and the second items gets assigned to</span>
<span class="sd">        column 2. Returns a dataframe with both columns.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">grouped</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>

        <span class="n">boot_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">boot_u</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">(</span><span class="n">boot_ci</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">boot_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span>
            <span class="n">boot_u</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span>
        <span class="n">df_boot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_list</span><span class="p">,</span>
                                <span class="s1">&#39;boot_l&#39;</span><span class="p">:</span> <span class="n">boot_l</span><span class="p">,</span>
                                <span class="s1">&#39;boot_u&#39;</span><span class="p">:</span> <span class="n">boot_u</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">df_boot</span>

<span class="c1">#    def _run_bootstrap(self, alpha, n_samples=9999):</span>
<span class="c1">#        &#39;&#39;&#39;</span>
<span class="c1">#        Calls the _compute_bootstrap() function.</span>
<span class="c1">#        &#39;&#39;&#39;</span>
<span class="c1">#        pctle = self._parse_alpha_list(alpha)</span>
<span class="c1">#        boot_ci = self._compute_bootstrap(alpha=pctle,</span>
<span class="c1">#                                          n_samples=n_samples)</span>
<span class="c1">##        if boot_ci is None:</span>
<span class="c1">##            boot_ci = []</span>
<span class="c1">##            for item in pctle_list:</span>
<span class="c1">##                boot_ci_temp = self._compute_bootstrap(alpha=item,</span>
<span class="c1">##                                                       n_samples=n_samples)</span>
<span class="c1">##                boot_ci.append(boot_ci_temp)</span>
<span class="c1">##        if boot_ci is None:</span>
<span class="c1">##            boot_ci = [None] * ((len(self.ci_list) * 2) + 2)</span>
<span class="c1">##        boot_ci = [self.eonr, self.eonr] + list(boot_ci)</span>
<span class="c1">##        df_boot = self._parse_boot_ci(boot_ci)</span>
<span class="c1">##        df_ci = pd.concat([df_ci, df_boot], axis=1)</span>
<span class="c1">#        return boot_ci</span>

<div class="viewcode-block" id="EONR.calc_delta"><a class="viewcode-back" href="../../my_eonr.html#eonr.eonr.EONR.calc_delta">[docs]</a>    <span class="k">def</span> <span class="nf">calc_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_results</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculates the change in EONR among economic scenarios</span>

<span class="sd">        Parameters:</span>
<span class="sd">            df_results (``Pandas dataframe``, optional): The dataframe</span>
<span class="sd">                containing the results from ``EONR.calculate_eonr()``</span>
<span class="sd">                (default: None).</span>

<span class="sd">        Returns:</span>
<span class="sd">            df_out &quot;The dataframe with the newly inserted EONR delta.&quot;</span>

<span class="sd">        Note:</span>
<span class="sd">            ``EONR.calc_delta()`` filters all data by location, year, and</span>
<span class="sd">            nitrogen timing, then the &quot;delta&quot; is calculated as the difference</span>
<span class="sd">            relative to the economic scenario resulting in the highest EONR.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">df_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_results</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">years</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">years</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">df_out</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
            <span class="n">df_year</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">year</span><span class="p">]</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">df_year</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">locs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">:</span>
                <span class="n">df_loc</span> <span class="o">=</span> <span class="n">df_year</span><span class="p">[</span><span class="n">df_year</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">loc</span><span class="p">]</span>
                <span class="n">times</span> <span class="o">=</span> <span class="n">df_loc</span><span class="p">[</span><span class="s1">&#39;time_n&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
                    <span class="n">df_yloct</span> <span class="o">=</span> <span class="n">df_loc</span><span class="p">[</span><span class="n">df_loc</span><span class="p">[</span><span class="s1">&#39;time_n&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">time</span><span class="p">]</span>
                    <span class="n">eonr_base</span> <span class="o">=</span> <span class="n">df_yloct</span><span class="p">[</span><span class="s1">&#39;eonr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="c1"># lowest fert:grain rat</span>
                    <span class="n">eonr_delta</span> <span class="o">=</span> <span class="n">df_yloct</span><span class="p">[</span><span class="s1">&#39;eonr&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">eonr_base</span>
                    <span class="n">df_yloct</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;eonr_delta&#39;</span><span class="p">,</span> <span class="n">eonr_delta</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">df_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">df_yloct</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="n">df_out</span> <span class="o">=</span> <span class="n">df_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_yloct</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_out</span></div>

<div class="viewcode-block" id="EONR.calculate_eonr"><a class="viewcode-back" href="../../my_eonr.html#eonr.eonr.EONR.calculate_eonr">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_eonr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">col_n_app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col_yld</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">col_crop_nup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col_n_avail</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">col_year</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col_location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col_time_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">bootstrap_ci</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">samples_boot</span><span class="o">=</span><span class="mi">9999</span><span class="p">,</span>
                       <span class="n">delta_tstat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculates the EONR and its confidence intervals</span>

<span class="sd">        Parameters:</span>
<span class="sd">            df (``Pandas dataframe``): The dataframe containing the</span>
<span class="sd">                experimental data.</span>
<span class="sd">            col_n_app (``str``, optional): Column name pointing to the rate of</span>
<span class="sd">                applied N fertilizer data (default: None).</span>
<span class="sd">            col_yld (``str``, optional): Column name pointing to the grain</span>
<span class="sd">                yield data. This column is multiplied by price_grain to create</span>
<span class="sd">                the &#39;grtn&#39; column in ``EONR.df_data`` (default: None).</span>
<span class="sd">            col_crop_nup (``str``, optional): Column name pointing to crop N</span>
<span class="sd">                uptake data (default: None).</span>
<span class="sd">            col_n_avail (``str``, optional): Column name pointing to available</span>
<span class="sd">                soil N at planting plus fertilizer throughout the season</span>
<span class="sd">                (default: None).</span>
<span class="sd">            col_year (``str``, optional): Column name pointing to year</span>
<span class="sd">                (default: None).</span>
<span class="sd">            col_location (``str``, optional): Column name pointing to location</span>
<span class="sd">                (default: None).</span>
<span class="sd">            col_time_n (``str``, optional): Column name pointing to nitrogen</span>
<span class="sd">                application timing (default: None).</span>
<span class="sd">            bootstrap_ci (``bool``, optional): Indicates whether bootstrap</span>
<span class="sd">                confidence intervals are to be computed. If calculating the</span>
<span class="sd">                EONR for many sites and/or economic scenarios, it may be</span>
<span class="sd">                desirable to set to ``False`` because the bootstrap confidence</span>
<span class="sd">                intervals take the most time to compute (default: False).</span>
<span class="sd">            samples_boot (``int``, optional): Number of samples in the</span>
<span class="sd">                bootstrap computation (default: 9999).</span>
<span class="sd">            delta_tstat (``bool``, optional): Indicates whether the</span>
<span class="sd">                difference from the t-statistic will be computed (as a function</span>
<span class="sd">                of theta2/N rate). May be useful to observe what optimization</span>
<span class="sd">                method is best suited to reach convergence when computing the</span>
<span class="sd">                profile-likelihood CIs (default: False).</span>

<span class="sd">        Note:</span>
<span class="sd">            ``col_n_app`` and ``col_yld`` are required by ``EONR``, but not</span>
<span class="sd">            necessarily by ``EONR.calculate_eonr()``. They must either be set</span>
<span class="sd">            during the initialization of EONR(), or be passed in this method.</span>

<span class="sd">        Note:</span>
<span class="sd">            ``col_crop_nup`` and ``col_n_avail`` are required to calculate the</span>
<span class="sd">            socially optimum nitrogen rate, SONR. The SONR is the optimum</span>
<span class="sd">            nitrogen rate considering the social cost of nitrogen, so</span>
<span class="sd">            therefore, ``EONR.cost_n_social`` must also be set.</span>

<span class="sd">        Note:</span>
<span class="sd">            ``col_year``, ``col_location``, and ``col_time_n`` are purely</span>
<span class="sd">            optional. They only affect the titles and axes labels of the plots.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set EONR.price_grain &gt; 0.&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_grain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="n">col_n_app</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_n_app</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_yld</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_yld</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_yld</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_crop_nup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_crop_nup</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_crop_nup</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_n_avail</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_n_avail</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_n_avail</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_ci</span> <span class="o">=</span> <span class="n">bootstrap_ci</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_temp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_replace_missing_vals</span><span class="p">(</span><span class="n">missing_val</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_grtn</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calc_social_cost</span><span class="p">(</span><span class="n">col_x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_avail</span><span class="p">,</span>
                                   <span class="n">col_y</span><span class="o">=</span><span class="s1">&#39;social_cost_n&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_nrtn</span><span class="p">(</span><span class="n">col_x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span><span class="p">,</span> <span class="n">col_y</span><span class="o">=</span><span class="s1">&#39;grtn&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solve_eonr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_R</span><span class="p">(</span><span class="n">col_x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span><span class="p">,</span> <span class="n">col_y</span><span class="o">=</span><span class="s1">&#39;grtn&#39;</span><span class="p">)</span>  <span class="c1"># models.update_eonr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_theta2_error</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{0}</span><span class="s1"> is past the point of available data, so confidence &#39;</span>
                  <span class="s1">&#39;bounds are not being computed&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onr_acr</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_no_ci</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_residuals</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_cis</span><span class="p">(</span><span class="n">col_x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span><span class="p">,</span> <span class="n">col_y</span><span class="o">=</span><span class="s1">&#39;grtn&#39;</span><span class="p">,</span>
                              <span class="n">bootstrap_ci</span><span class="o">=</span><span class="n">bootstrap_ci</span><span class="p">,</span>
                              <span class="n">samples_boot</span><span class="o">=</span><span class="n">samples_boot</span><span class="p">,</span>
                              <span class="n">delta_tstat</span><span class="o">=</span><span class="n">delta_tstat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_mrtn_lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">costs_at_onr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rtn_derivative</span><span class="p">()</span>
<span class="c1">#        self._ci_pdf()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_out</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_grtn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_results</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_zero</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">base_zero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn_primary</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span>
            <span class="n">grtn_y_int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">grtn_y_int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;b0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span>
        <span class="s1">&#39;unit_grain&#39;</span><span class="p">,</span> <span class="s1">&#39;unit_costs&#39;</span><span class="p">,</span>
        <span class="n">unit_price_grain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_rtn</span>
        <span class="n">unit_cost_n</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> per </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_currency</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">unit_fert</span><span class="p">)</span>
        <span class="n">last_run_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;run_n&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">df_ci_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;run_n&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">last_run_n</span><span class="p">)</span> <span class="o">&amp;</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_level</span><span class="p">)]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">price_grain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_fert</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">costs_fixed</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">price_ratio</span><span class="p">,</span> <span class="n">unit_price_grain</span><span class="p">,</span> <span class="n">unit_cost_n</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_temp</span><span class="p">,</span>
                    <span class="n">base_zero</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eonr</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coefs_nrtn</span><span class="p">[</span><span class="s1">&#39;eonr_bias&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">costs_at_onr</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ci_level</span><span class="p">,</span> <span class="n">df_ci_last</span><span class="p">[</span><span class="s1">&#39;wald_l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">df_ci_last</span><span class="p">[</span><span class="s1">&#39;wald_u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">df_ci_last</span><span class="p">[</span><span class="s1">&#39;pl_l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">df_ci_last</span><span class="p">[</span><span class="s1">&#39;pl_u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">df_ci_last</span><span class="p">[</span><span class="s1">&#39;boot_l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">df_ci_last</span><span class="p">[</span><span class="s1">&#39;boot_u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mrtn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;r2_adj&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;max_y&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coefs_grtn</span><span class="p">[</span><span class="s1">&#39;crit_x&#39;</span><span class="p">],</span>
                    <span class="n">grtn_y_int</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results_temp</span><span class="p">[</span><span class="s1">&#39;scn_lin_r2&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results_temp</span><span class="p">[</span><span class="s1">&#39;scn_lin_rmse&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results_temp</span><span class="p">[</span><span class="s1">&#39;scn_exp_r2&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results_temp</span><span class="p">[</span><span class="s1">&#39;scn_exp_rmse&#39;</span><span class="p">]]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_results</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
                <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="EONR.plot_eonr"><a class="viewcode-back" href="../../my_eonr.html#eonr.eonr.EONR.plot_eonr">[docs]</a>    <span class="k">def</span> <span class="nf">plot_eonr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ci_type</span><span class="o">=</span><span class="s1">&#39;profile-likelihood&#39;</span><span class="p">,</span> <span class="n">ci_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">run_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">show_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;ggplot&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Plots EONR, MRTN, GRTN, net return, and nitrogen cost</span>

<span class="sd">        Parameters:</span>
<span class="sd">            ci_type (``str``, optional): Indicates which confidence interval</span>
<span class="sd">                type should be plotted. Options are &#39;wald&#39;, to plot the Wald</span>
<span class="sd">                CIs; &#39;profile-likelihood&#39;, to plot the profile-likelihood</span>
<span class="sd">                CIs; or &#39;bootstrap&#39;, to plot the bootstrap CIs (default:</span>
<span class="sd">                &#39;profile-likelihood&#39;).</span>
<span class="sd">            ci_level (``float``, optional): The confidence interval level to be</span>
<span class="sd">                plotted, and must be one of the values in EONR.ci_list. If</span>
<span class="sd">                ``None``, uses the</span>
<span class="sd">                ``EONR.ci_level`` (default: None).</span>
<span class="sd">            run_n (``int``, optional): NOT IMPLEMENTED. The run number to plot,</span>
<span class="sd">                as indicated in EONR.df_results; if None, uses the most recent,</span>
<span class="sd">                or maximum, run_n in EONR.df_results (default: None).</span>
<span class="sd">            x_min (``int``, optional): The minimum x-bounds of the plot</span>
<span class="sd">                (default: None)</span>
<span class="sd">            x_max (``int``, optional): The maximum x-bounds of the plot</span>
<span class="sd">                (default: None)</span>
<span class="sd">            y_min (``int``, optional): The minimum y-bounds of the plot</span>
<span class="sd">                (default: None)</span>
<span class="sd">            y_max (``int``, optional): The maximum y-bounds of the plot</span>
<span class="sd">                (default: None)</span>
<span class="sd">            show_model (str): Whether to display the type of fitted model in</span>
<span class="sd">                the helper legend (default: True).</span>
<span class="sd">            style (``str``, optional): The style of the plolt; can be any of</span>
<span class="sd">                the options supported by ``matplotlib``</span>

<span class="sd">        Note:</span>
<span class="sd">            ``x_min``, ``x_max``, ``y_min``, and ``y_max`` are set by</span>
<span class="sd">            Matplotlib if left as ``None``.</span>

<span class="sd">        .. _matplotlib:</span>
<span class="sd">            https://tonysyu.github.io/raw_content/matplotlib-style-gallery/gallery.html</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span> <span class="o">=</span> <span class="n">Plotting_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">update_eonr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">plot_eonr</span><span class="p">(</span><span class="n">ci_type</span><span class="o">=</span><span class="n">ci_type</span><span class="p">,</span> <span class="n">ci_level</span><span class="o">=</span><span class="n">ci_level</span><span class="p">,</span>
                                      <span class="n">run_n</span><span class="o">=</span><span class="n">run_n</span><span class="p">,</span> <span class="n">x_min</span><span class="o">=</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="o">=</span><span class="n">x_max</span><span class="p">,</span>
                                      <span class="n">y_min</span><span class="o">=</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="o">=</span><span class="n">y_max</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig_eonr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">fig_eonr</span></div>

<div class="viewcode-block" id="EONR.plot_modify_size"><a class="viewcode-back" href="../../my_eonr.html#eonr.eonr.EONR.plot_modify_size">[docs]</a>    <span class="k">def</span> <span class="nf">plot_modify_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plotsize_x</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">plotsize_y</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                         <span class="n">labelsize</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Modifies the size of the last plot generated</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fig (``Matplotlib Figure``, optional): Matplotlib figure to modify</span>
<span class="sd">                (default: None)</span>
<span class="sd">            plotsize_x (``float``, optional): Sets x size of plot in inches</span>
<span class="sd">                (default: 7)</span>
<span class="sd">            plotsize_y (``float``, optional): Sets y size of plot in inches</span>
<span class="sd">                (default: 4)</span>
<span class="sd">            labelsize (``float``, optional): Sets tick and label</span>
<span class="sd">                (defaulat: 11)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">modify_size</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">plotsize_x</span><span class="o">=</span><span class="n">plotsize_x</span><span class="p">,</span>
                                        <span class="n">plotsize_y</span><span class="o">=</span><span class="n">plotsize_y</span><span class="p">,</span>
                                        <span class="n">labelsize</span><span class="o">=</span><span class="n">labelsize</span><span class="p">)</span></div>

<div class="viewcode-block" id="EONR.plot_modify_title"><a class="viewcode-back" href="../../my_eonr.html#eonr.eonr.EONR.plot_modify_title">[docs]</a>    <span class="k">def</span> <span class="nf">plot_modify_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title_text</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size_font</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Allows user to replace the title text</span>

<span class="sd">        Parameters:</span>
<span class="sd">            title_text (``str``): New title text</span>
<span class="sd">            g (``matplotlib.figure``): Matplotlib figure object to modify</span>
<span class="sd">                (default: None)</span>
<span class="sd">            size_font (``float``): Font size to use (default: 12)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">modify_title</span><span class="p">(</span><span class="n">title_text</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">size_font</span><span class="o">=</span><span class="n">size_font</span><span class="p">)</span></div>

<div class="viewcode-block" id="EONR.plot_save"><a class="viewcode-back" href="../../my_eonr.html#eonr.eonr.EONR.plot_save">[docs]</a>    <span class="k">def</span> <span class="nf">plot_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Saves a generated matplotlib figure to file</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname (``str``, optional): Filename to save plot to (default: None)</span>
<span class="sd">            base_dir (``str``, optional): Base file directory when saving</span>
<span class="sd">                results (default: None)</span>
<span class="sd">            fig (eonr.fig, optional): EONR figure object to save (default:</span>
<span class="sd">                None)</span>
<span class="sd">            dpi (``int``, optional): Resolution to save the figure to in dots</span>
<span class="sd">                per inch (default: 300)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">plot_save</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
                                      <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span></div>

<div class="viewcode-block" id="EONR.plot_delta_tstat"><a class="viewcode-back" href="../../my_eonr.html#eonr.eonr.EONR.plot_delta_tstat">[docs]</a>    <span class="k">def</span> <span class="nf">plot_delta_tstat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;ggplot&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Plots the test statistic as a function nitrogen rate</span>

<span class="sd">        Parameters:</span>
<span class="sd">            level_list (``list``): The confidence levels to plot; should be a</span>
<span class="sd">                subset of items in EONR.ci_list (default: None).</span>
<span class="sd">            style (``str``, optional): The style of the plolt; can be any of</span>
<span class="sd">                the options supported by ``matplotlib``</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span> <span class="o">=</span> <span class="n">Plotting_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">update_eonr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">plot_delta_tstat</span><span class="p">(</span><span class="n">level_list</span><span class="o">=</span><span class="n">level_list</span><span class="p">,</span>
                                             <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig_delta_tstat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">fig_delta_tstat</span></div>

<div class="viewcode-block" id="EONR.plot_derivative"><a class="viewcode-back" href="../../my_eonr.html#eonr.eonr.EONR.plot_derivative">[docs]</a>    <span class="k">def</span> <span class="nf">plot_derivative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ci_type</span><span class="o">=</span><span class="s1">&#39;profile-likelihood&#39;</span><span class="p">,</span> <span class="n">ci_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">style</span><span class="o">=</span><span class="s1">&#39;ggplot&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Plots a zoomed up view of the ONR and the derivative</span>

<span class="sd">        Parameters:</span>
<span class="sd">            ci_type (str): Indicates which confidence interval type should be</span>
<span class="sd">                plotted. Options are &#39;wald&#39;, to plot the Wald</span>
<span class="sd">                CIs; &#39;profile-likelihood&#39;, to plot the profile-likelihood</span>
<span class="sd">                CIs; or &#39;bootstrap&#39;, to plot the bootstrap CIs (default:</span>
<span class="sd">                &#39;profile-likelihood&#39;).</span>
<span class="sd">            ci_level (float): The confidence interval level to be plotted, and</span>
<span class="sd">                must be one of the values in EONR.ci_list. If None, uses the</span>
<span class="sd">                EONR.ci_level (default: None).</span>
<span class="sd">            level (``float``): The confidence levels to plot; should be a</span>
<span class="sd">                value from EONR.ci_list (default: 0.90).</span>
<span class="sd">            style (``str``, optional): The style of the plolt; can be any of</span>
<span class="sd">                the options supported by ``matplotlib``</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span> <span class="o">=</span> <span class="n">Plotting_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">update_eonr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">plot_derivative</span><span class="p">(</span><span class="n">ci_type</span><span class="o">=</span><span class="n">ci_type</span><span class="p">,</span> <span class="n">ci_level</span><span class="o">=</span><span class="n">ci_level</span><span class="p">,</span>
                                            <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig_derivative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">fig_derivative</span></div>

<div class="viewcode-block" id="EONR.plot_tau"><a class="viewcode-back" href="../../my_eonr.html#eonr.eonr.EONR.plot_tau">[docs]</a>    <span class="k">def</span> <span class="nf">plot_tau</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;t_stat&#39;</span><span class="p">,</span> <span class="n">emphasis</span><span class="o">=</span><span class="s1">&#39;profile-likelihood&#39;</span><span class="p">,</span>
                 <span class="n">run_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;ggplot&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Plots the test statistic as a function nitrogen rate</span>

<span class="sd">        Parameters:</span>
<span class="sd">            y_axis (``str``, optional): Value to plot on the y-axis. Options</span>
<span class="sd">                are &#39;t_stat&#39;, to plot the *T statistic*; &#39;f_stat&#39;, to plot the</span>
<span class="sd">                *F-statistic*; or &#39;level&#39;, to plot the *confidence level*;</span>
<span class="sd">                (default: &#39;t_stat&#39;).</span>
<span class="sd">            emphasis (``str``, optional): Indicates which confidence interval</span>
<span class="sd">                type, if any, should be emphasized. Options are &#39;wald&#39;, to</span>
<span class="sd">                empahsize the Wald CIs;</span>
<span class="sd">                &#39;profile-likelihood&#39;, to empahsize the profile-likelihood CIs;</span>
<span class="sd">                &#39;bootstrap&#39;, to empahsize the bootstrap CIs; or</span>
<span class="sd">                ``None``, to empahsize no CI (default: &#39;profile-likelihood&#39;).</span>
<span class="sd">            run_n (``int``, optional): The run number to plot, as indicated in</span>
<span class="sd">                ``EONR.df_ci``; if ``None``, uses the most recent, or maximum,</span>
<span class="sd">                run_n in ``EONR.df_ci`` (default: None).</span>
<span class="sd">            style (``str``, optional): The style of the plolt; can be any of</span>
<span class="sd">                the options supported by ``matplotlib``</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span> <span class="o">=</span> <span class="n">Plotting_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">update_eonr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">plot_tau</span><span class="p">(</span><span class="n">y_axis</span><span class="o">=</span><span class="n">y_axis</span><span class="p">,</span> <span class="n">emphasis</span><span class="o">=</span><span class="n">emphasis</span><span class="p">,</span>
                                     <span class="n">run_n</span><span class="o">=</span><span class="n">run_n</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig_tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting_tools</span><span class="o">.</span><span class="n">fig_tau</span></div>

<div class="viewcode-block" id="EONR.print_results"><a class="viewcode-back" href="../../my_eonr.html#eonr.eonr.EONR.print_results">[docs]</a>    <span class="k">def</span> <span class="nf">print_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Prints the results of the optimum nitrogen rate computation</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_results</span><span class="p">()</span></div>

<div class="viewcode-block" id="EONR.set_column_names"><a class="viewcode-back" href="../../my_eonr.html#eonr.eonr.EONR.set_column_names">[docs]</a>    <span class="k">def</span> <span class="nf">set_column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_n_app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col_yld</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col_crop_nup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">col_n_avail</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col_year</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">col_location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col_time_n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sets the column name(s) for ``EONR.df_data``</span>

<span class="sd">        Parameters:</span>
<span class="sd">            col_n_app (``str``, optional): Column name pointing to the rate of</span>
<span class="sd">                applied N fertilizer data (default: None).</span>
<span class="sd">            col_yld (``str``, optional): Column name pointing to the grain</span>
<span class="sd">                yield data. This column is multiplied by price_grain to create</span>
<span class="sd">                the &#39;grtn&#39; column in ``EONR.df_data`` (default: None).</span>
<span class="sd">            col_crop_nup (``str``, optional): Column name pointing to crop N</span>
<span class="sd">                uptake data (default: None).</span>
<span class="sd">            col_n_avail (``str``, optional): Column name pointing to available</span>
<span class="sd">                soil N at planting plus fertilizer throughout the season</span>
<span class="sd">                (default: None).</span>
<span class="sd">            col_year (``str``, optional): Column name pointing to year</span>
<span class="sd">                (default: None).</span>
<span class="sd">            col_location (``str``, optional): Column name pointing to location</span>
<span class="sd">                (default: None).</span>
<span class="sd">            col_time_n (``str``, optional): Column name pointing to nitrogen</span>
<span class="sd">                application timing (default: None).</span>

<span class="sd">        Note:</span>
<span class="sd">            Year, location, or nitrogen timing (used for titles and axes labels</span>
<span class="sd">            for plotting).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">col_n_app</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_n_app</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_n_app</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_yld</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_yld</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_yld</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_crop_nup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_crop_nup</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_crop_nup</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_n_avail</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_n_avail</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_n_avail</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_year</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_year</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_location</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_location</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_time_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_time_n</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_time_n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_find_trial_details</span><span class="p">()</span>  <span class="c1"># Use new col_name(s) to update details</span></div>

<div class="viewcode-block" id="EONR.set_trial_details"><a class="viewcode-back" href="../../my_eonr.html#eonr.eonr.EONR.set_trial_details">[docs]</a>    <span class="k">def</span> <span class="nf">set_trial_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_timing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sets the year, location, or nitrogen timing</span>

<span class="sd">        Parameters:</span>
<span class="sd">            year (``str`` or ``int``, optional): Year of experimental trial</span>
<span class="sd">                (default: None)</span>
<span class="sd">            location (``str`` or ``int``, optional): Location of experimental</span>
<span class="sd">                trial (default: None)</span>
<span class="sd">            n_timing (``str`` or ``int``, optional): Nitrogen timing of</span>
<span class="sd">                experimental trial (default: None)</span>

<span class="sd">        Note:</span>
<span class="sd">            Year, location, or nitrogen timing (used for titles and axes labels</span>
<span class="sd">            for plotting).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">year</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
        <span class="k">if</span> <span class="n">n_timing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_timing</span> <span class="o">=</span> <span class="n">n_timing</span></div>

<div class="viewcode-block" id="EONR.update_econ"><a class="viewcode-back" href="../../my_eonr.html#eonr.eonr.EONR.update_econ">[docs]</a>    <span class="k">def</span> <span class="nf">update_econ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cost_n_fert</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cost_n_social</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">costs_fixed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">price_grain</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sets or resets the nitrogen costs or grain price</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cost_n_fert (``float``, optional): Cost of nitrogen fertilizer</span>
<span class="sd">                (default: None).</span>
<span class="sd">            cost_n_social (``float``, optional): Cost of pollution caused by</span>
<span class="sd">                excess nitrogen (default: None).</span>
<span class="sd">            costs_fixed (float, optional): Fixed costs on a per area basis</span>
<span class="sd">            (default: None)</span>
<span class="sd">            price_grain (``float``, optional): Price of grain (default: None).</span>

<span class="sd">        Note:</span>
<span class="sd">            ``update_econ()`` recomputes the price ratio based on the passed</span>
<span class="sd">            information, then adjusts/renames the lowest level folder in the</span>
<span class="sd">            base directory, ``EONR.base_dir``, based on to the ratio. The</span>
<span class="sd">            folder name is set according to the economic scenario (useful when</span>
<span class="sd">            running ``EONR`` for many different economic scenarios then</span>
<span class="sd">            plotting and saving results for each scenario). See examples below.</span>

<span class="sd">            Example 1 (*how folder name is set when social cost of nitrogen is</span>
<span class="sd">            zero*): folder name will be set to **&quot;trad_0010&quot;** if</span>
<span class="sd">            ``cost_n_social == 0`` and ``price_ratio == 0.10``, coresponding to</span>
<span class="sd">            *&quot;trad&quot;* and *&quot;0010&quot;* in the folder name, respectively.</span>

<span class="sd">            Example 2 (*how folder name is set when social cost of nitrogen is</span>
<span class="sd">            greater than zero*): folder name will be set to</span>
<span class="sd">            **&quot;social_154_1100&quot;** if ``cost_n_social &gt; 0``,</span>
<span class="sd">            ``price_ratio = 15.4``, and ``cost_n_social = 1.10``, corresponding</span>
<span class="sd">            to *&quot;social&quot;*, *&quot;154&quot;*, and *&quot;1100&quot;* in the folder name,</span>
<span class="sd">            respectively.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">cost_n_fert</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_fert</span> <span class="o">=</span> <span class="n">cost_n_fert</span>  <span class="c1"># in USD per lb</span>
        <span class="k">if</span> <span class="n">cost_n_social</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">=</span> <span class="n">cost_n_social</span>  <span class="c1"># in USD per lb lost</span>
        <span class="k">if</span> <span class="n">costs_fixed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">costs_fixed</span> <span class="o">=</span> <span class="n">costs_fixed</span>  <span class="c1"># in USD per lb lost</span>
        <span class="k">if</span> <span class="n">price_grain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">price_grain</span> <span class="o">=</span> <span class="n">price_grain</span>  <span class="c1"># in USD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_ratio</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_n_fert</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span><span class="p">)</span> <span class="o">/</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">price_grain</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">join_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1:.3f}</span><span class="s1">_</span><span class="si">{2:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s1">&#39;social&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">join_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1:.1f}</span><span class="s1">_</span><span class="si">{2:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s1">&#39;social&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">join_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;trad&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_ratio</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">join_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;trad&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_ratio</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">join_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;trad&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_ratio</span><span class="p">)</span>
            <span class="n">join_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[.]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">join_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                         <span class="n">join_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_social</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onr_name</span> <span class="o">=</span> <span class="s1">&#39;Socially&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onr_acr</span> <span class="o">=</span> <span class="s1">&#39;SONR&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_n_fert</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onr_name</span> <span class="o">=</span> <span class="s1">&#39;Economic&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onr_acr</span> <span class="o">=</span> <span class="s1">&#39;EONR&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onr_name</span> <span class="o">=</span> <span class="s1">&#39;Agronomic&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onr_acr</span> <span class="o">=</span> <span class="s1">&#39;AONR&#39;</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Tyler J Nigon.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>